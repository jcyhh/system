{"version":3,"file":"list.js","sources":["pages/notice/list.vue","pages/notice/list.vue?type=page"],"sourcesContent":["<template>\n\t<view class=\"pl30 pr30 pt30\">\n\t\t\n\t\t<view class=\"card mb20\" v-for=\"item in noticeList\" :key=\"item._id\">\n\t\t\t<view @click=\"goDetail(item._id)\">\n\t\t\t\t<view class=\"flex jb ac\">\n\t\t\t\t\t<view class=\"size32 bold line2 flex1\">{{ item.title }}</view>\n\t\t\t\t\t<view class=\"flex ac\" v-if=\"isAdmin\">\n\t\t\t\t\t\t<view class=\"status-tag unpublish\" v-if=\"!item.is_published\">未发布</view>\n\t\t\t\t\t\t<view class=\"status-tag popup ml10\" v-if=\"item.is_popup\">弹窗</view>\n\t\t\t\t\t</view>\n\t\t\t\t</view>\n\t\t\t\t<view class=\"flex jb ac mt20\">\n\t\t\t\t\t<view class=\"size24 gray\">{{ formatTime(item.create_time) }}</view>\n\t\t\t\t\t<view class=\"flex ac\" v-if=\"isAdmin\" @click.stop>\n\t\t\t\t\t\t<uni-icons type=\"compose\" :size=\"20\" @click=\"editNotice(item)\"></uni-icons>\n\t\t\t\t\t\t<uni-icons type=\"trash\" :size=\"20\" color=\"#dd524d\" class=\"ml30\" @click=\"deleteNotice(item)\"></uni-icons>\n\t\t\t\t\t</view>\n\t\t\t\t</view>\n\t\t\t</view>\n\t\t</view>\n\t\t\n\t\t<view class=\"tc mt60 size28 gray\" v-if=\"noticeList.length === 0 && !isLoading\">\n\t\t\t<view class=\"flex jc\">\n\t\t\t\t<image src=\"@/static/imgs/nodata.png\" class=\"img200\"></image>\n\t\t\t</view>\n\t\t\t暂无公告\n\t\t</view>\n\t\t\n\t\t<!-- 加载状态 -->\n\t\t<view class=\"tc size28 gray mt30 mb30\" v-if=\"isLoading\">\n\t\t\t加载中...\n\t\t</view>\n\t\t<view class=\"tc size28 gray mt30 mb30\" v-else-if=\"!hasMore && noticeList.length > 0\">\n\t\t\t没有更多了\n\t\t</view>\n\t\t\n\t</view>\n\t\n\t<view class=\"gap130\" v-if=\"isAdmin\"></view>\n\t<view class=\"safeBottom\"></view>\n\t<view class=\"btn flex jc ac\" v-if=\"isAdmin\" @click=\"addNotice\">添加公告</view>\n</template>\n\n<script lang=\"ts\" setup>\nimport { ref, computed } from 'vue';\nimport { onLoad, onShow, onPullDownRefresh, onReachBottom } from '@dcloudio/uni-app';\nimport { useAppStore } from '@/store';\n\nconst appStore = useAppStore()\n\nconst noticeList = ref<any[]>([])\nconst page = ref(1)\nconst pageSize = 20\nconst hasMore = ref(true)\nconst isLoading = ref(false)\n\n// 判断是否是管理员\nconst isAdmin = computed(() => {\n\treturn appStore.isLogin && appStore.role === 1\n})\n\n// 加载公告列表\nconst loadNoticeList = async (isRefresh = false) => {\n\tif (isLoading.value) return\n\tif (!hasMore.value && !isRefresh) return\n\t\n\ttry {\n\t\tisLoading.value = true\n\t\t\n\t\t// 如果是刷新，重置页码\n\t\tif (isRefresh) {\n\t\t\tpage.value = 1\n\t\t\thasMore.value = true\n\t\t}\n\t\t\n\t\tconst noticeObj = uniCloud.importObject('notice')\n\t\tconst res = await noticeObj.getList({\n\t\t\tpage: page.value,\n\t\t\tpageSize: pageSize,\n\t\t\tshowAll: isAdmin.value // 管理员显示所有公告\n\t\t})\n\t\t\n\t\tif (res.errCode === 0) {\n\t\t\tif (isRefresh) {\n\t\t\t\tnoticeList.value = res.data.list\n\t\t\t} else {\n\t\t\t\tnoticeList.value = [...noticeList.value, ...res.data.list]\n\t\t\t}\n\t\t\t\n\t\t\t// 判断是否还有更多数据\n\t\t\tif (res.data.list.length < pageSize) {\n\t\t\t\thasMore.value = false\n\t\t\t}\n\t\t\t\n\t\t\t// 加载成功，页码+1\n\t\t\tif (res.data.list.length > 0) {\n\t\t\t\tpage.value++\n\t\t\t}\n\t\t} else {\n\t\t\tuni.showToast({\n\t\t\t\ttitle: res.errMsg || '获取失败',\n\t\t\t\ticon: 'none'\n\t\t\t})\n\t\t}\n\t} catch (e: any) {\n\t\tuni.__f__('error','at pages/notice/list.vue:107','获取失败：', e)\n\t\tuni.showToast({\n\t\t\ttitle: e.message || '获取失败',\n\t\t\ticon: 'none'\n\t\t})\n\t} finally {\n\t\tisLoading.value = false\n\t}\n}\n\n// 格式化时间\nconst formatTime = (timestamp: number) => {\n\tconst date = new Date(timestamp)\n\tconst year = date.getFullYear()\n\tconst month = String(date.getMonth() + 1).padStart(2, '0')\n\tconst day = String(date.getDate()).padStart(2, '0')\n\tconst hour = String(date.getHours()).padStart(2, '0')\n\tconst minute = String(date.getMinutes()).padStart(2, '0')\n\treturn `${year}-${month}-${day} ${hour}:${minute}`\n}\n\n// 跳转到详情页\nconst goDetail = (id: string) => {\n\tuni.navigateTo({\n\t\turl: `/pages/notice/detail?id=${id}`\n\t})\n}\n\n// 添加公告\nconst addNotice = () => {\n\tuni.navigateTo({\n\t\turl: '/pages/notice/edit'\n\t})\n}\n\n// 编辑公告\nconst editNotice = (item: any) => {\n\tuni.navigateTo({\n\t\turl: `/pages/notice/edit?id=${item._id}`\n\t})\n}\n\n// 删除公告\nconst deleteNotice = (item: any) => {\n\tuni.showModal({\n\t\ttitle: '提示',\n\t\tcontent: '确定要删除这条公告吗？',\n\t\tsuccess: async (res) => {\n\t\t\tif (res.confirm) {\n\t\t\t\ttry {\n\t\t\t\t\tconst noticeObj = uniCloud.importObject('notice')\n\t\t\t\t\tconst result = await noticeObj.delete({ id: item._id })\n\t\t\t\t\t\n\t\t\t\t\tif (result.errCode === 0) {\n\t\t\t\t\t\tuni.showToast({\n\t\t\t\t\t\t\ttitle: '删除成功',\n\t\t\t\t\t\t\ticon: 'success'\n\t\t\t\t\t\t})\n\t\t\t\t\t\t// 刷新列表\n\t\t\t\t\t\tawait loadNoticeList(true)\n\t\t\t\t\t} else {\n\t\t\t\t\t\tuni.showToast({\n\t\t\t\t\t\t\ttitle: result.errMsg || '删除失败',\n\t\t\t\t\t\t\ticon: 'none'\n\t\t\t\t\t\t})\n\t\t\t\t\t}\n\t\t\t\t} catch (e: any) {\n\t\t\t\t\tuni.__f__('error','at pages/notice/list.vue:174','删除失败：', e)\n\t\t\t\t\tuni.showToast({\n\t\t\t\t\t\ttitle: e.message || '删除失败',\n\t\t\t\t\t\ticon: 'none'\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t})\n}\n\n// 页面加载\nonLoad(() => {\n\tloadNoticeList(true)\n})\n\n// 页面显示时刷新列表（从编辑页返回时）\nonShow(() => {\n\t// 不是首次加载时才刷新\n\tif (noticeList.value.length > 0) {\n\t\tloadNoticeList(true)\n\t}\n})\n\n// 下拉刷新\nonPullDownRefresh(async () => {\n\ttry {\n\t\tawait loadNoticeList(true)\n\t\tuni.showToast({\n\t\t\ttitle: '刷新成功',\n\t\t\ticon: 'success'\n\t\t})\n\t} catch (e) {\n\t\tuni.__f__('error','at pages/notice/list.vue:207','刷新失败：', e)\n\t} finally {\n\t\tuni.stopPullDownRefresh()\n\t}\n})\n\n// 触底加载更多\nonReachBottom(() => {\n\tloadNoticeList()\n})\n</script>\n\n<style lang=\"scss\" scoped>\n.line2 {\n\tdisplay: -webkit-box;\n\t-webkit-box-orient: vertical;\n\t-webkit-line-clamp: 2;\n\toverflow: hidden;\n\ttext-overflow: ellipsis;\n}\n\n.status-tag {\n\tpadding: 4rpx 16rpx;\n\tborder-radius: 8rpx;\n\tfont-size: 22rpx;\n\twhite-space: nowrap;\n\t\n\t&.unpublish {\n\t\tbackground-color: #FFF3E0;\n\t\tcolor: #FF9800;\n\t}\n\t\n\t&.popup {\n\t\tbackground-color: #E3F2FD;\n\t\tcolor: #2196F3;\n\t}\n}\n\n.btn{\n\twidth: 690rpx;\n\theight: 88rpx;\n\tborder-radius: 44rpx;\n\tbackground-color: $main-color;\n\tcolor: #FFFFFF;\n\tposition: fixed;\n\tbottom: calc(var(--safe-area-inset-bottom) + 30rpx);\n\tleft: 30rpx;\n}\n</style>\n","import MiniProgramPage from '/Users/jcy/code/wx/system/pages/notice/list.vue'\nwx.createPage(MiniProgramPage)"],"names":["useAppStore","ref","computed","uniCloud","uni","onLoad","onShow","onPullDownRefresh","onReachBottom"],"mappings":"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"}