{"version":3,"file":"finished.js","sources":["pages/mine/finished.vue","pages/mine/finished.vue?type=page"],"sourcesContent":["<template>\n\t<view class=\"tabs flex ac wrap\" v-if=\"tags.length>0\">\n\t\t<view class=\"tag flex ac mr10 mb10\" v-for=\"(item,index) in tags\" :key=\"index\">{{ item }}</view>\n\t</view>\n\t\n\t<view class=\"search flex jc ac\" @click=\"filterRef?.open()\">\n\t\t<uni-icons type=\"search\" color=\"#FFFFFF\" :size=\"35\"></uni-icons>\n\t</view>\n\t<view class=\"export flex jc ac\" @click=\"exportExcel\">\n\t\t<uni-icons type=\"redo-filled\" color=\"#FFFFFF\" :size=\"35\"></uni-icons>\n\t</view>\n\t\n\t<view class=\"pl30 pr30 mt30\">\n\t\t\n\t\t<view class=\"card mb20\" v-for=\"(item,index) in finishedList\" :key=\"item._id\" @click=\"goDetail(item)\">\n\t\t\t<view class=\"flex jb ac\">\n\t\t\t\t<image src=\"/static/imgs/avatar.png\" class=\"img100\"></image>\n\t\t\t\t<view class=\"flex1 ml20\">\n\t\t\t\t\t<view class=\"flex jb ac size30\">\n\t\t\t\t\t\t<view>{{ item.driver_name }}</view>\n\t\t\t\t\t\t<view class=\"bold\">{{ item.plate_number }}</view>\n\t\t\t\t\t</view>\n\t\t\t\t\t<view class=\"size26 mt10\">{{ item.phone }}</view>\n\t\t\t\t</view>\n\t\t\t</view>\n\t\t\t<view class=\"line mt30 mb30\"></view>\n\t\t\t<view class=\"flex jb ac mt30\">\n\t\t\t\t<view class=\"size28 bold\">到达时间</view>\n\t\t\t\t<view class=\"size26 gray\">{{ formatTime(item.create_time) }}</view>\n\t\t\t</view>\n\t\t\t<view class=\"flex jb ac mt20\">\n\t\t\t\t<view class=\"size28 bold\">完成时间</view>\n\t\t\t\t<view class=\"size26 gray\">{{ formatTime(item.complete_time) }}</view>\n\t\t\t</view>\n\t\t</view>\n\t\t\n\t\t<view class=\"tc mt60 size28 gray\" v-if=\"finishedList.length === 0 && !isLoading\">\n\t\t\t<view class=\"flex jc\">\n\t\t\t\t<image src=\"@/static/imgs/nodata.png\" class=\"img200\"></image>\n\t\t\t</view>\n\t\t\t暂无已完成的单子\n\t\t</view>\n\t\t\n\t\t<!-- 加载状态 -->\n\t\t<view class=\"tc size28 gray mt30 mb30\" v-if=\"isLoading\">\n\t\t\t加载中...\n\t\t</view>\n\t\t<view class=\"tc size28 gray mt30 mb30\" v-else-if=\"!hasMore && finishedList.length > 0\">\n\t\t\t没有更多了\n\t\t</view>\n\t\t\n\t</view>\n\t\n\t<view class=\"gap50\"></view>\n\t\n\t<Filter ref=\"filterRef\" @submit=\"onFilter\"></Filter>\n\t\n\t<Excel ref=\"excelRef\"></Excel>\n</template>\n\n<script lang=\"ts\" setup>\nimport { ref } from 'vue';\nimport { onLoad, onPullDownRefresh, onReachBottom } from '@dcloudio/uni-app';\nimport Filter from './Filter.vue'\nimport Excel from './Excel.vue'\n\nconst filterRef = ref()\nconst excelRef = ref()\nconst finishedList = ref<any[]>([])\nconst tags = ref<string[]>([])\nconst params = ref<any>({})\nconst page = ref(1)\nconst pageSize = 20\nconst hasMore = ref(true)\nconst isLoading = ref(false)\n\n// 加载已完成的单子\nconst loadFinishedList = async (isRefresh = false) => {\n\tif (isLoading.value) return\n\tif (!hasMore.value && !isRefresh) return\n\t\n\ttry {\n\t\tisLoading.value = true\n\t\t\n\t\t// 如果是刷新，重置页码\n\t\tif (isRefresh) {\n\t\t\tpage.value = 1\n\t\t\thasMore.value = true\n\t\t}\n\t\t\n\t\tconst truckObj = uniCloud.importObject('truck')\n\t\tconst res = await truckObj.getFinishedList({\n\t\t\tpage: page.value,\n\t\t\tpageSize: pageSize,\n\t\t\t...params.value\n\t\t})\n\t\t\n\t\tif (res.errCode === 0) {\n\t\t\tif (isRefresh) {\n\t\t\t\tfinishedList.value = res.data.list\n\t\t\t} else {\n\t\t\t\tfinishedList.value = [...finishedList.value, ...res.data.list]\n\t\t\t}\n\t\t\t\n\t\t\t// 判断是否还有更多数据\n\t\t\tif (res.data.list.length < pageSize) {\n\t\t\t\thasMore.value = false\n\t\t\t}\n\t\t\t\n\t\t\t// 加载成功，页码+1\n\t\t\tif (res.data.list.length > 0) {\n\t\t\t\tpage.value++\n\t\t\t}\n\t\t} else {\n\t\t\tuni.showToast({\n\t\t\t\ttitle: res.errMsg || '获取失败',\n\t\t\t\ticon: 'none'\n\t\t\t})\n\t\t}\n\t} catch (e: any) {\n\t\tuni.__f__('error','at pages/mine/finished.vue:121','获取失败：', e)\n\t\tuni.showToast({\n\t\t\ttitle: e.message || '获取失败',\n\t\t\ticon: 'none'\n\t\t})\n\t} finally {\n\t\tisLoading.value = false\n\t}\n}\n\n// 筛选回调\nconst onFilter = (data: any) => {\n\ttags.value = data.tags\n\t\n\t// 转换筛选参数\n\tconst filterParams: any = {}\n\t\n\t// 车型\n\tif (data.params.carType !== undefined) {\n\t\tconst typesList = ['依维柯', '3.8米', '4.2米', '7.6米', '9.6米', '13.5米', '17.5米及以上']\n\t\tfilterParams.truck_type = typesList[data.params.carType]\n\t}\n\t\n\t// 装卸车类型\n\tif (data.params.type !== undefined) {\n\t\tfilterParams.operation_type = data.params.type  // 0装车/1卸车\n\t}\n\t\n\t// 时间范围（使用iOS兼容的日期格式）\n\tif (data.params.startTime && data.params.endTime) {\n\t\tfilterParams.start_time = new Date(data.params.startTime.replace(/-/g, '/') + ' 00:00:00').getTime()\n\t\tfilterParams.end_time = new Date(data.params.endTime.replace(/-/g, '/') + ' 23:59:59').getTime()\n\t}\n\t\n\t// 车牌号\n\tif (data.params.cardNo) {\n\t\tfilterParams.plate_number = data.params.cardNo\n\t}\n\t\n\t// 手机号\n\tif (data.params.phoneNo) {\n\t\tfilterParams.phone = data.params.phoneNo\n\t}\n\t\n\t// 姓名\n\tif (data.params.name) {\n\t\tfilterParams.driver_name = data.params.name\n\t}\n\t\n\tparams.value = filterParams\n\tloadFinishedList(true)\n}\n\n// 格式化时间\nconst formatTime = (timestamp: number) => {\n\tif (!timestamp) return ''\n\tconst date = new Date(timestamp)\n\tconst month = String(date.getMonth() + 1).padStart(2, '0')\n\tconst day = String(date.getDate()).padStart(2, '0')\n\tconst hour = String(date.getHours()).padStart(2, '0')\n\tconst minute = String(date.getMinutes()).padStart(2, '0')\n\treturn `${month}-${day} ${hour}:${minute}`\n}\n\n// 跳转到详情页\nconst goDetail = (item: any) => {\n\tuni.navigateTo({\n\t\turl: `/pages/mine/detail?id=${item._id}`\n\t})\n}\n\n// 导出Excel（暂未实现）\nconst exportExcel = () => {\n\texcelRef.value?.open()\n}\n\n// 页面加载\nonLoad(() => {\n\tloadFinishedList(true)\n})\n\n// 下拉刷新\nonPullDownRefresh(async () => {\n\ttry {\n\t\tawait loadFinishedList(true)\n\t\tuni.showToast({\n\t\t\ttitle: '刷新成功',\n\t\t\ticon: 'success'\n\t\t})\n\t} catch (e) {\n\t\tuni.__f__('error','at pages/mine/finished.vue:211','刷新失败：', e)\n\t} finally {\n\t\tuni.stopPullDownRefresh()\n\t}\n})\n\n// 触底加载更多\nonReachBottom(() => {\n\tloadFinishedList()\n})\n</script>\n\n<style lang=\"scss\" scoped>\n.tabs{\n\twidth: 100vw;\n\tpadding: 30rpx 30rpx 10rpx 30rpx;\n\tbackground-color: #FFFFFF;\n\tposition: sticky;\n\ttop: var(--window-top);\n\tleft: 0;\n\tz-index: 10;\n\tbox-shadow: 0 10rpx 10rpx #eeeeee;\n\t.tag{\n\t\tborder: 1rpx solid $main-color;\n\t\theight: 68rpx;\n\t\tborder-radius: 10rpx;\n\t\tcolor: $main-color;\n\t\tpadding: 0 20rpx;\n\t}\n}\n.line{\n\twidth: 100%;\n\theight: 1rpx;\n\tbackground-color: #eeeeee;\n}\n.search{\n\twidth: 100rpx;\n\theight: 100rpx;\n\tborder-radius: 50%;\n\tbackground-color: $main-color;\n\tbox-shadow: 0 0 20rpx #999999;\n\tposition: fixed;\n\tbottom: 100rpx;\n\tright: 30rpx;\n}\n.export{\n\twidth: 100rpx;\n\theight: 100rpx;\n\tborder-radius: 50%;\n\tbackground-color: $main-color;\n\tbox-shadow: 0 0 20rpx #999999;\n\tposition: fixed;\n\tbottom: 250rpx;\n\tright: 30rpx;\n}\n</style>\n","import MiniProgramPage from '/Users/jcy/code/wx/system/pages/mine/finished.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","uniCloud","uni","onLoad","onPullDownRefresh","onReachBottom"],"mappings":"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"}