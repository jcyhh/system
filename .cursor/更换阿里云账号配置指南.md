# 更换阿里云账号配置指南

## 📋 概述

当更换阿里云服务器账号后，需要重新配置 uniCloud 服务空间并迁移数据。

---

## 🔧 必须修改的配置

### 1. HBuilderX 中重新关联云服务空间

#### 步骤：

1. **创建新的云服务空间**
   - 登录 [uniCloud 控制台](https://unicloud.dcloud.net.cn/)
   - 使用新的阿里云账号登录
   - 创建新的服务空间（建议命名：`system-prod` 或类似）
   - 记录服务空间 ID

2. **在 HBuilderX 中关联新空间**
   - 右键点击项目根目录
   - 选择 `关联云服务空间或项目`
   - 选择 `uniCloud-aliyun` 目录
   - 选择刚创建的新服务空间
   - 点击确认

3. **验证关联**
   ```
   项目根目录 → 右键 → 云服务空间详情
   确认显示的是新的服务空间信息
   ```

---

### 2. 重新创建数据库表

#### 方法 1：通过 Schema 自动创建（推荐）

1. **上传数据库 Schema**
   ```
   uniCloud-aliyun/database/ 目录
   → 右键每个 .schema.json 文件
   → 上传 DB Schema
   ```

   需要上传的文件：
   - `trucks.schema.json` - 车辆排队表
   - `notices.schema.json` - 公告表
   - `uni-id-users.schema.json` - 用户表（系统自带）
   - `uni-id-users.schema.ext.json` - 用户表扩展
   - `uni-id-roles.schema.json` - 角色表

2. **验证表创建**
   - 打开 uniCloud Web 控制台
   - 检查数据库中是否有以下表：
     - `trucks`
     - `notices`
     - `uni-id-users`
     - `uni-id-roles`

#### 方法 2：手动创建表

如果自动创建失败，参考 `.cursor/数据库表结构说明.md`

---

### 3. 初始化数据

#### 3.1 创建管理员账号

**方式 1：通过小程序注册后手动修改**

1. 在小程序中注册一个账号
2. 在 uniCloud 控制台 → 数据库 → `uni-id-users`
3. 找到刚注册的用户
4. 修改 `role` 字段：
   ```json
   {
     "role": 1
   }
   ```

**方式 2：直接在数据库中添加**

在 `uni-id-users` 表中添加记录：
```json
{
  "username": "admin",
  "mobile": "你的手机号",
  "role": 1,
  "wx_openid": {
    "mp": "通过小程序登录后获取"
  },
  "register_date": 1737014400000
}
```

#### 3.2 添加示例公告（可选）

在 `notices` 表中添加：
```json
{
  "title": "入院须知",
  "content": "<div style='line-height: 1.8;'><p><strong>1. 院内严禁吸烟，违者罚款1000元</strong></p><p>2. 卸完货请点击完成并上传照片</p><p>3. 单据在拐角处一楼第三个房间办公室签字</p></div>",
  "is_published": true,
  "is_popup": true,
  "create_time": 当前时间戳,
  "update_time": 当前时间戳
}
```

---

### 4. 上传云函数

上传所有云函数到新的服务空间：

```
uniCloud-aliyun/cloudfunctions/
├── truck/        → 右键 → 上传并部署
├── user/         → 右键 → 上传并部署
└── notice/       → 右键 → 上传并部署
```

#### 验证云函数

在 uniCloud 控制台 → 云函数 → 检查是否有：
- `truck`
- `user`
- `notice`

---

### 5. 配置云存储（用于图片上传）

1. 打开 uniCloud 控制台
2. 点击左侧 `云存储`
3. 创建存储桶（如果没有）
4. 记录存储桶名称（一般会自动创建）

**前端已配置好，无需修改代码**

---

## ⚠️ 不需要修改的地方

### ✅ 代码层面

以下文件/配置**不需要修改**：

1. **微信小程序配置**
   - `appid` 和 `appsecret` 仍然有效
   - 云函数中的微信 API 调用不受影响

2. **前端代码**
   - 所有 `.vue` 文件不需要修改
   - `uniCloud.importObject()` 会自动连接新的服务空间

3. **云函数代码**
   - `truck/index.obj.js`
   - `user/index.obj.js`
   - `notice/index.obj.js`
   - 这些文件的代码不需要修改，只需重新上传

4. **数据库 Schema**
   - 所有 `.schema.json` 文件不需要修改
   - 只需重新上传即可

---

## 📊 数据迁移（如果需要保留旧数据）

### 方案 1：手动导出导入（推荐用于小数据量）

1. **导出旧数据**
   - 登录旧的 uniCloud 控制台
   - 数据库 → 选择表 → 导出数据（JSON 格式）
   - 导出以下表：
     - `trucks`
     - `notices`
     - `uni-id-users`

2. **导入新数据**
   - 登录新的 uniCloud 控制台
   - 数据库 → 选择表 → 导入数据
   - 上传之前导出的 JSON 文件

### 方案 2：使用云函数迁移（推荐用于大数据量）

参考 uniCloud 官方文档的数据迁移方案。

---

## 🧪 测试清单

完成配置后，请测试以下功能：

### 1. 用户相关
- [ ] 小程序登录功能
- [ ] 管理员身份验证
- [ ] 用户信息显示

### 2. 排队功能
- [ ] 提交排队申请
- [ ] 查看排队列表
- [ ] 查看当前任务
- [ ] 上传完成照片
- [ ] 管理员确认完成

### 3. 订阅消息
- [ ] 排队到号通知
- [ ] 排队进度通知
- [ ] 排队成功提醒

⚠️ **注意**：订阅消息需要小程序在正式环境或体验版才能正常接收

### 4. 公告功能
- [ ] 首页显示公告轮播
- [ ] 查看公告列表
- [ ] 查看公告详情
- [ ] 公告弹窗显示
- [ ] 管理员添加公告
- [ ] 管理员编辑公告
- [ ] 管理员删除公告

### 5. 云存储
- [ ] 上传完成照片
- [ ] 图片正常显示

---

## 🔍 常见问题

### Q1: 云函数调用失败

**错误**：`Cloud function not found` 或 `uniCloud is not defined`

**解决**：
1. 确认已在 HBuilderX 中关联新的服务空间
2. 确认已上传所有云函数
3. 重新编译运行小程序（重要！）

---

### Q2: 数据库操作失败

**错误**：`Collection not found`

**解决**：
1. 检查数据库表是否创建成功
2. 重新上传 DB Schema
3. 检查表名是否正确（区分大小写）

---

### Q3: 订阅消息收不到

**可能原因**：
1. 微信小程序需要是正式版或体验版
2. 用户未订阅消息模板
3. `access_token` 获取失败

**解决**：
1. 在云函数日志中查看详细错误
2. 确认 `appid` 和 `appsecret` 正确
3. 检查微信小程序后台的订阅消息配置

---

### Q4: 图片上传失败

**错误**：`Upload failed` 或 `No storage available`

**解决**：
1. 确认云存储已开通
2. 检查存储空间配额是否充足
3. 重新编译运行小程序

---

### Q5: 管理员权限无效

**问题**：登录后仍显示普通用户

**解决**：
1. 检查数据库中用户的 `role` 字段是否为 `1`
2. 重新登录小程序
3. 清除小程序缓存后重新登录

---

## 📌 关键配置位置

### uniCloud 服务空间 ID

**位置**：HBuilderX 项目配置文件
```
.hbuilderx/
└── uniCloud-aliyun.json  (自动生成，无需手动修改)
```

### 微信小程序配置

**位置**：云函数中硬编码
```javascript
// uniCloud-aliyun/cloudfunctions/truck/index.obj.js
const appid = 'wx93f72f4bacc468f4';
const appsecret = '6e54ef01b2ca76c2b37fe360774ce7ae';
```

⚠️ **这两个配置不需要修改**（除非换了微信小程序账号）

---

## ✅ 完整操作步骤总结

1. **创建新服务空间** → uniCloud 控制台
2. **关联新空间** → HBuilderX 中操作
3. **上传 DB Schema** → 自动创建数据库表
4. **上传云函数** → truck, user, notice
5. **创建管理员账号** → 数据库中手动添加
6. **添加初始数据** → 公告等（可选）
7. **重新编译运行** → 测试所有功能
8. **数据迁移** → 如果需要保留旧数据

---

## 📞 技术支持

如遇到问题，可以：
1. 查看 uniCloud 控制台的云函数日志
2. 查看 HBuilderX 控制台的前端日志
3. 参考 uniCloud 官方文档：https://uniapp.dcloud.net.cn/uniCloud/

---

## 🎯 预计耗时

- **基础配置**：15-30 分钟
- **数据迁移**：根据数据量，10 分钟 - 1 小时
- **测试验证**：20-30 分钟
- **总计**：约 1-2 小时

---

## 🚀 配置完成后

完成所有配置后，建议：

1. **完整测试**：走一遍完整的业务流程
2. **性能监控**：观察云函数调用次数和响应时间
3. **成本控制**：查看阿里云账单，避免超出预算
4. **数据备份**：定期备份重要数据

---

## 📝 备注

- 新的阿里云账号可能有免费额度，注意查看
- 如果是从开发版升级到正式版，建议使用新的服务空间
- 保留旧服务空间一段时间，以防需要回退
