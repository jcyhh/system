# 微信登录流程说明

## 一、登录流程图

```
小程序启动
    ↓
检查本地是否有token
    ↓
有token → 验证token是否有效
    ↓               ↓
  有效          无效/没有token
    ↓               ↓
进入首页      弹出授权获取手机号
                    ↓
              调用微信登录接口
                    ↓
              保存token到本地
                    ↓
              进入首页
```

---

## 二、App.vue 登录逻辑

在 `App.vue` 中添加全局登录检查：

```vue
<script>
export default {
  onLaunch: async function() {
    console.log('App Launch')
    
    // 检查登录状态
    await this.checkLogin()
  },
  
  onShow: function() {
    console.log('App Show')
  },
  
  onHide: function() {
    console.log('App Hide')
  },
  
  methods: {
    async checkLogin() {
      try {
        // 获取本地token
        const token = uni.getStorageSync('uni_id_token')
        
        if (!token) {
          console.log('未登录，等待用户操作')
          return false
        }
        
        // 验证token是否有效
        const userObj = uniCloud.importObject('user')
        const res = await userObj.getUserInfo()
        
        if (res.errCode === 0) {
          // token有效，保存用户信息
          uni.setStorageSync('userInfo', res.data)
          console.log('登录有效')
          return true
        } else {
          // token无效，清除本地数据
          uni.removeStorageSync('uni_id_token')
          uni.removeStorageSync('userInfo')
          console.log('登录已失效')
          return false
        }
      } catch (e) {
        console.error('检查登录状态失败', e)
        return false
      }
    }
  }
}
</script>
```

---

## 三、登录页面实现

### pages/login/login.vue

```vue
<template>
  <view class="login-page">
    <view class="logo">
      <image src="/static/logo.png" mode="aspectFit"></image>
    </view>
    
    <view class="title">仓库卸货管理系统</view>
    <view class="desc">请使用微信登录</view>
    
    <button 
      type="primary" 
      open-type="getPhoneNumber" 
      @getphonenumber="getPhoneNumber"
      :disabled="logging"
    >
      {{ logging ? '登录中...' : '微信一键登录' }}
    </button>
    
    <view class="tips">
      登录即表示同意《用户协议》和《隐私政策》
    </view>
  </view>
</template>

<script>
export default {
  data() {
    return {
      logging: false
    }
  },
  
  methods: {
    async getPhoneNumber(e) {
      if (e.detail.errMsg !== 'getPhoneNumber:ok') {
        uni.showToast({
          title: '取消授权',
          icon: 'none'
        })
        return
      }
      
      this.logging = true
      
      try {
        // 获取微信登录code
        const loginRes = await uni.login({
          provider: 'weixin'
        })
        
        // 调用云对象登录
        const userObj = uniCloud.importObject('user')
        const res = await userObj.loginByWeixin({
          code: loginRes.code
        })
        
        this.logging = false
        
        if (res.errCode === 0) {
          // 保存token
          uni.setStorageSync('uni_id_token', res.data.token)
          uni.setStorageSync('userInfo', res.data.userInfo)
          
          uni.showToast({
            title: '登录成功',
            icon: 'success'
          })
          
          // 返回上一页或跳转到首页
          setTimeout(() => {
            const pages = getCurrentPages()
            if (pages.length > 1) {
              uni.navigateBack()
            } else {
              uni.switchTab({
                url: '/pages/index/index'
              })
            }
          }, 1000)
        } else {
          uni.showToast({
            title: res.errMsg || '登录失败',
            icon: 'none'
          })
        }
      } catch (e) {
        this.logging = false
        console.error('登录失败', e)
        uni.showToast({
          title: '登录失败，请重试',
          icon: 'none'
        })
      }
    }
  }
}
</script>

<style scoped>
.login-page {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding: 60rpx;
  background: linear-gradient(to bottom, #4facfe, #00f2fe);
}

.logo {
  width: 200rpx;
  height: 200rpx;
  margin-bottom: 60rpx;
}

.logo image {
  width: 100%;
  height: 100%;
}

.title {
  font-size: 48rpx;
  font-weight: bold;
  color: #fff;
  margin-bottom: 20rpx;
}

.desc {
  font-size: 28rpx;
  color: rgba(255, 255, 255, 0.8);
  margin-bottom: 100rpx;
}

button {
  width: 500rpx;
  height: 88rpx;
  line-height: 88rpx;
  background: #fff;
  color: #4facfe;
  border-radius: 44rpx;
  font-size: 32rpx;
  font-weight: bold;
}

.tips {
  margin-top: 40rpx;
  font-size: 24rpx;
  color: rgba(255, 255, 255, 0.6);
}
</style>
```

---

## 四、登录拦截器

### 在 main.js 中添加全局拦截

```javascript
import { createSSRApp } from 'vue'
import App from './App.vue'

export function createApp() {
  const app = createSSRApp(App)
  
  return {
    app
  }
}

// 页面跳转拦截器
const requireLogin = [
  '/pages/register/register',
  '/pages/complete/complete',
  '/pages/my/my'
]

uni.addInterceptor('navigateTo', {
  invoke(e) {
    const token = uni.getStorageSync('uni_id_token')
    
    // 检查是否需要登录
    const needLogin = requireLogin.some(path => e.url.includes(path))
    
    if (needLogin && !token) {
      uni.showModal({
        title: '提示',
        content: '请先登录',
        showCancel: false,
        success() {
          uni.navigateTo({
            url: '/pages/login/login'
          })
        }
      })
      return false
    }
  }
})

uni.addInterceptor('switchTab', {
  invoke(e) {
    const token = uni.getStorageSync('uni_id_token')
    
    // 如果跳转到"我的"页面，需要登录
    if (e.url.includes('/pages/my/my') && !token) {
      uni.showModal({
        title: '提示',
        content: '请先登录',
        showCancel: false,
        success() {
          uni.navigateTo({
            url: '/pages/login/login'
          })
        }
      })
      return false
    }
  }
})
```

---

## 五、修改后的页面调用示例

### 1. 到达登记页面（register.vue）

在原有基础上修改：

```javascript
methods: {
  async submit() {
    // 检查登录
    const token = uni.getStorageSync('uni_id_token')
    if (!token) {
      uni.showModal({
        title: '提示',
        content: '请先登录',
        showCancel: false,
        success() {
          uni.navigateTo({
            url: '/pages/login/login'
          })
        }
      })
      return
    }
    
    // ... 原有的提交逻辑
    
    try {
      // 上传照片
      const photoUrl = await this.uploadImage()
      
      // 导入云对象（会自动携带token）
      const truck = uniCloud.importObject('truck')
      
      // 调用登记接口
      const res = await truck.register({
        driver_name: this.form.driver_name,
        phone: this.form.phone,
        plate_number: this.form.plate_number,
        truck_length: this.form.truck_length,
        loading_place: this.form.loading_place,
        arrival_photo: photoUrl
      })
      
      // ... 处理返回结果
    } catch (e) {
      // 如果是登录过期错误
      if (e.message && e.message.includes('请先登录')) {
        uni.removeStorageSync('uni_id_token')
        uni.showModal({
          title: '提示',
          content: '登录已过期，请重新登录',
          showCancel: false,
          success() {
            uni.navigateTo({
              url: '/pages/login/login'
            })
          }
        })
      } else {
        uni.showToast({
          title: '操作失败',
          icon: 'none'
        })
      }
    }
  }
}
```

### 2. 查询当前任务（complete.vue）

```javascript
methods: {
  // 查询当前任务
  async searchTask() {
    uni.showLoading({ title: '查询中...' })
    
    try {
      const truck = uniCloud.importObject('truck')
      // 无需传参，后端根据登录用户自动查询
      const res = await truck.getCurrentTask()
      
      uni.hideLoading()
      
      if (res.errCode === 0 && res.data) {
        this.recordInfo = res.data
        uni.setStorageSync('current_record_id', res.data._id)
      } else {
        uni.showToast({ title: '未找到进行中的任务', icon: 'none' })
      }
    } catch (e) {
      uni.hideLoading()
      console.error('查询失败', e)
    }
  }
}
```

---

## 六、我的页面（查询历史记录）

### pages/my/my.vue

```vue
<template>
  <view class="my-page">
    <!-- 用户信息 -->
    <view class="user-info">
      <image :src="userInfo.avatar || '/static/default-avatar.png'" class="avatar"></image>
      <text class="nickname">{{ userInfo.nickname || '微信用户' }}</text>
    </view>
    
    <!-- 统计信息 -->
    <view class="stats">
      <view class="stat-item">
        <text class="stat-num">{{ stats.total }}</text>
        <text class="stat-label">总次数</text>
      </view>
      <view class="stat-item">
        <text class="stat-num">{{ stats.processing }}</text>
        <text class="stat-label">进行中</text>
      </view>
      <view class="stat-item">
        <text class="stat-num">{{ stats.completed }}</text>
        <text class="stat-label">已完成</text>
      </view>
    </view>
    
    <!-- 历史记录 -->
    <view class="history-title">历史记录</view>
    
    <scroll-view 
      scroll-y 
      class="history-list"
      @scrolltolower="loadMore"
    >
      <view 
        class="record-item" 
        v-for="item in list" 
        :key="item._id"
        @click="viewDetail(item)"
      >
        <view class="record-header">
          <text class="queue-num">{{ item.queue_number }}号</text>
          <text :class="['status', item.status]">
            {{ statusText[item.status] }}
          </text>
        </view>
        <view class="record-info">
          <text>车牌：{{ item.plate_number }}</text>
          <text>车长：{{ item.truck_length }}</text>
        </view>
        <view class="record-time">
          {{ formatTime(item.arrival_time) }}
        </view>
      </view>
      
      <view v-if="list.length === 0" class="empty">暂无记录</view>
      <view v-if="noMore && list.length > 0" class="no-more">没有更多了</view>
    </scroll-view>
  </view>
</template>

<script>
export default {
  data() {
    return {
      userInfo: {},
      stats: {
        total: 0,
        processing: 0,
        completed: 0
      },
      list: [],
      page: 1,
      pageSize: 20,
      noMore: false,
      statusText: {
        waiting: '排队中',
        processing: '处理中',
        completed: '已完成'
      }
    }
  },
  
  onLoad() {
    this.loadUserInfo()
    this.loadStats()
    this.loadList()
  },
  
  methods: {
    loadUserInfo() {
      const userInfo = uni.getStorageSync('userInfo')
      if (userInfo) {
        this.userInfo = userInfo
      }
    },
    
    async loadStats() {
      try {
        const truck = uniCloud.importObject('truck')
        const res = await truck.getMyRecords(1, 1000)
        
        if (res.errCode === 0) {
          this.stats.total = res.data.total
          this.stats.processing = res.data.list.filter(item => 
            item.status === 'processing' || item.status === 'waiting'
          ).length
          this.stats.completed = res.data.list.filter(item => 
            item.status === 'completed'
          ).length
        }
      } catch (e) {
        console.error('加载统计失败', e)
      }
    },
    
    async loadList() {
      uni.showLoading({ title: '加载中...' })
      
      try {
        const truck = uniCloud.importObject('truck')
        const res = await truck.getMyRecords(this.page, this.pageSize)
        
        uni.hideLoading()
        
        if (res.errCode === 0) {
          if (this.page === 1) {
            this.list = res.data.list
          } else {
            this.list = [...this.list, ...res.data.list]
          }
          
          if (this.list.length >= res.data.total) {
            this.noMore = true
          }
        }
      } catch (e) {
        uni.hideLoading()
        console.error('加载列表失败', e)
      }
    },
    
    loadMore() {
      if (this.noMore) return
      this.page++
      this.loadList()
    },
    
    viewDetail(item) {
      uni.navigateTo({
        url: `/pages/detail/detail?id=${item._id}`
      })
    },
    
    formatTime(timestamp) {
      const date = new Date(timestamp)
      const Y = date.getFullYear()
      const M = (date.getMonth() + 1).toString().padStart(2, '0')
      const D = date.getDate().toString().padStart(2, '0')
      const h = date.getHours().toString().padStart(2, '0')
      const m = date.getMinutes().toString().padStart(2, '0')
      return `${Y}-${M}-${D} ${h}:${m}`
    }
  }
}
</script>

<style scoped>
.my-page {
  min-height: 100vh;
  background: #f5f5f5;
}

.user-info {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 60rpx;
  background: linear-gradient(to bottom, #4facfe, #00f2fe);
}

.avatar {
  width: 140rpx;
  height: 140rpx;
  border-radius: 70rpx;
  border: 4rpx solid #fff;
  margin-bottom: 20rpx;
}

.nickname {
  font-size: 36rpx;
  color: #fff;
  font-weight: bold;
}

.stats {
  display: flex;
  background: #fff;
  padding: 40rpx 0;
}

.stat-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.stat-num {
  font-size: 48rpx;
  color: #333;
  font-weight: bold;
}

.stat-label {
  font-size: 24rpx;
  color: #999;
  margin-top: 10rpx;
}

.history-title {
  padding: 30rpx;
  font-size: 32rpx;
  font-weight: bold;
  color: #333;
}

.history-list {
  height: calc(100vh - 500rpx);
}

.record-item {
  background: #fff;
  margin: 0 30rpx 20rpx;
  padding: 30rpx;
  border-radius: 10rpx;
}

.record-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20rpx;
}

.queue-num {
  font-size: 32rpx;
  font-weight: bold;
  color: #333;
}

.status {
  font-size: 24rpx;
  padding: 6rpx 16rpx;
  border-radius: 4rpx;
}

.status.waiting {
  background: #f0f0f0;
  color: #999;
}

.status.processing {
  background: #fff3e0;
  color: #ff9500;
}

.status.completed {
  background: #e8f5e9;
  color: #4cd964;
}

.record-info {
  display: flex;
  justify-content: space-between;
  font-size: 28rpx;
  color: #666;
  margin-bottom: 15rpx;
}

.record-time {
  font-size: 24rpx;
  color: #999;
}

.empty, .no-more {
  text-align: center;
  padding: 60rpx;
  color: #999;
  font-size: 28rpx;
}
</style>
```

---

## 七、pages.json 配置

添加登录页和我的页面：

```json
{
  "pages": [
    {
      "path": "pages/index/index",
      "style": {
        "navigationBarTitleText": "仓库卸货管理"
      }
    },
    {
      "path": "pages/login/login",
      "style": {
        "navigationBarTitleText": "登录",
        "navigationStyle": "custom"
      }
    },
    {
      "path": "pages/register/register",
      "style": {
        "navigationBarTitleText": "到达登记"
      }
    },
    {
      "path": "pages/complete/complete",
      "style": {
        "navigationBarTitleText": "完成卸货"
      }
    },
    {
      "path": "pages/list/list",
      "style": {
        "navigationBarTitleText": "排队列表"
      }
    },
    {
      "path": "pages/my/my",
      "style": {
        "navigationBarTitleText": "我的"
      }
    }
  ],
  "tabBar": {
    "color": "#999",
    "selectedColor": "#007aff",
    "backgroundColor": "#fff",
    "borderStyle": "black",
    "list": [
      {
        "pagePath": "pages/index/index",
        "text": "首页",
        "iconPath": "static/tab-home.png",
        "selectedIconPath": "static/tab-home-active.png"
      },
      {
        "pagePath": "pages/list/list",
        "text": "排队",
        "iconPath": "static/tab-list.png",
        "selectedIconPath": "static/tab-list-active.png"
      },
      {
        "pagePath": "pages/my/my",
        "text": "我的",
        "iconPath": "static/tab-my.png",
        "selectedIconPath": "static/tab-my-active.png"
      }
    ]
  }
}
```

---

## 八、注意事项

1. **token自动携带**：使用 `uniCloud.importObject()` 时会自动携带 token，无需手动处理
2. **token过期处理**：后端验证失败会抛出错误，前端捕获后引导用户重新登录
3. **微信手机号**：小程序需要通过 `open-type="getPhoneNumber"` 获取手机号授权
4. **隐私协议**：使用手机号快速登录需要配置隐私协议
5. **登录拦截**：建议在需要登录的页面都加上登录检查逻辑

