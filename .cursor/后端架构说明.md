# 仓库卸货管理系统 - 后端架构说明

## 项目概述

基于 **uniCloud** 云开发平台，为微信小程序提供后端服务的仓库卸货排队管理系统。

---

## 目录结构

```
/uniCloud-aliyun/
├── cloudfunctions/              # 云函数/云对象目录
│   ├── common/                  # 公共模块
│   │   └── uni-config-center/   # 配置中心
│   │       └── uni-id/          # uni-id配置
│   │           └── config.json  # 用户体系配置文件
│   ├── truck/                   # 卸货管理云对象
│   │   ├── index.obj.js         # 云对象主文件
│   │   └── package.json         # 依赖配置
│   └── user/                    # 用户管理云对象
│       ├── index.obj.js         # 云对象主文件
│       └── package.json         # 依赖配置
└── database/                    # 数据库目录
    ├── trucks.schema.json       # 卸货记录表结构
    └── db_init.json            # 数据库初始化数据
```

---

## 技术栈

- **云开发平台**：uniCloud（阿里云版）
- **开发语言**：JavaScript
- **数据库**：云数据库（MongoDB-like）
- **用户体系**：uni-id-common
- **架构模式**：云对象（Object）

---

## 核心模块

### 1. 数据库设计

#### trucks 表（卸货记录表）

| 字段名 | 类型 | 说明 | 必填 |
|--------|------|------|------|
| _id | String | 记录ID（自动生成） | 是 |
| driver_name | String | 司机姓名 | 是 |
| phone | String | 联系电话（11位手机号） | 是 |
| plate_number | String | 车牌号 | 是 |
| truck_length | String | 车长 | 是 |
| loading_place | String | 装货地点 | 是 |
| arrival_time | Timestamp | 到达时间 | 是 |
| arrival_photo | String | 到达照片URL | 否 |
| unload_time | Timestamp | 卸货完成时间 | 否 |
| unload_photo | String | 卸货完成照片URL | 否 |
| status | String | 状态：waiting/processing/completed | 是 |
| queue_number | Int | 排队号码 | 是 |
| create_time | Timestamp | 创建时间（自动） | 是 |
| update_time | Timestamp | 更新时间（自动） | 是 |

**权限配置：**
- read: 所有人可读
- create: 所有人可创建
- update: 只有未完成的记录可更新
- delete: 禁止删除

---

### 2. 云对象

#### 2.1 truck 云对象（卸货管理）

**文件位置：** `/uniCloud-aliyun/cloudfunctions/truck/index.obj.js`

**核心方法：**

| 方法名 | 功能 | 参数 |
|--------|------|------|
| register | 司机到达登记 | data（登记信息对象） |
| complete | 完成卸货 | id, unload_photo |
| getList | 获取排队列表 | status, page, pageSize |
| getDetail | 获取记录详情 | id |
| getCurrentTask | 查询当前任务 | phone, plate_number |
| getQueueStats | 获取排队统计 | 无 |

**业务逻辑：**

1. **register（登记）**
   - 验证参数完整性和格式
   - 检查是否有重复未完成的记录
   - 计算排队号码
   - 判断是否是第一个（是则状态为processing，否则为waiting）
   - 插入数据库

2. **complete（完成）**
   - 验证记录存在性
   - 检查当前状态是否为processing
   - 更新当前记录为completed
   - 查找下一个waiting状态的记录
   - 将下一个记录状态改为processing

3. **getList（列表）**
   - 支持状态筛选
   - 按到达时间升序排序
   - 支持分页

#### 2.2 user 云对象（用户管理）

**文件位置：** `/uniCloud-aliyun/cloudfunctions/user/index.obj.js`

**核心方法：**

| 方法名 | 功能 | 参数 |
|--------|------|------|
| loginByWeixin | 微信小程序登录 | code |
| getUserInfo | 获取用户信息 | 无（需token） |
| updateUserInfo | 更新用户信息 | userInfo |

**依赖模块：**
- uni-id-common（用户体系核心模块）

---

### 3. 配置文件

#### 3.1 uni-id 配置

**文件位置：** `/uniCloud-aliyun/cloudfunctions/common/uni-config-center/uni-id/config.json`

**核心配置项：**

```json
{
  "passwordSecret": "密码加密密钥",
  "tokenSecret": "token加密密钥",
  "tokenExpiresIn": 7200000,  // token有效期（2小时）
  "mp-weixin": {
    "oauth": {
      "weixin": {
        "appid": "微信小程序AppID",
        "appsecret": "微信小程序AppSecret"
      }
    }
  }
}
```

**重要提示：** 需要替换以下信息：
- `passwordSecret`: 自定义密码加密密钥
- `tokenSecret`: 自定义token加密密钥
- `mp-weixin.oauth.weixin.appid`: 微信小程序AppID
- `mp-weixin.oauth.weixin.appsecret`: 微信小程序AppSecret

---

## 业务流程

### 完整流程图

```
1. 司机到达仓库
   ↓
2. 扫描小程序二维码
   ↓
3. 填写信息并上传照片
   ↓
4. 调用 truck.register() 登记
   ↓
5. 系统分配排队号，判断状态
   - 如果是第一个 → status = 'processing'
   - 否则 → status = 'waiting'
   ↓
6. 显示排队信息
   ↓
7. 等待前面的车辆卸货完成
   ↓
8. 状态自动变为 'processing'
   ↓
9. 开始卸货
   ↓
10. 卸货完成后再次扫码
    ↓
11. 上传卸货完成照片
    ↓
12. 调用 truck.complete() 完成
    ↓
13. 系统自动将下一个 waiting 改为 processing
    ↓
14. 当前记录状态变为 'completed'
```

---

## 状态流转

```
waiting（排队中）
    ↓ 前一个完成时自动触发
processing（处理中）
    ↓ 司机手动完成
completed（已完成）
```

**规则：**
- 同一时间只有1个 processing
- 可以有多个 waiting
- completed 不再变化

---

## 权限设计

### 数据库权限

在 `trucks.schema.json` 中配置：

```json
"permission": {
  "read": true,                    // 所有人可读
  "create": true,                  // 所有人可创建
  "update": "doc.status != 'completed'",  // 只有未完成的可更新
  "delete": false                  // 禁止删除
}
```

### 云对象权限

目前未启用严格的权限校验，如需要可在 `_before` 方法中添加：

```javascript
_before: async function () {
  // 可以在这里进行权限校验
  // 例如：只允许登录用户操作
  const uniIdIns = uniID.createInstance({
    context: this.ctx
  });
  const payload = await uniIdIns.checkToken(this.ctx.CLOUDFUNCTION_CONTEXT.TOKEN);
  if (payload.errCode !== 0) {
    throw new Error('请先登录');
  }
}
```

---

## 性能优化建议

1. **索引优化**
   - 在 `status` 字段创建索引（用于状态筛选）
   - 在 `arrival_time` 字段创建索引（用于排序）
   - 组合索引：`{phone: 1, plate_number: 1, status: 1}`（用于查询当前任务）

2. **并发控制**
   - `complete` 方法中的状态更新可以使用数据库事务保证原子性
   - 防止同时完成导致的状态混乱

3. **缓存策略**
   - 统计数据可以缓存5-10秒，减少数据库查询

---

## 扩展功能建议

### 1. 管理员功能
- 创建 `admin` 云对象
- 提供手动调整顺序、强制完成、取消记录等功能

### 2. 消息推送
- 当状态变为 processing 时推送模板消息给司机
- 提醒前面还有几辆车时发送通知

### 3. 数据统计
- 每日卸货数量统计
- 平均卸货时长统计
- 高峰时段分析

### 4. 二维码生成
- 创建云函数生成专属二维码
- 二维码携带仓库信息参数

### 5. 照片处理
- 上传前自动压缩图片
- 用户使用外部水印相机App添加水印后上传

---

## 部署步骤

### 1. 初始化uniCloud

在 HBuilderX 中：
1. 右键 `uniCloud-aliyun` → 关联云服务空间
2. 选择或创建阿里云服务空间

### 2. 上传云函数

1. 右键 `truck` 文件夹 → 上传部署
2. 右键 `user` 文件夹 → 上传部署
3. 右键 `common` 文件夹 → 上传公共模块

### 3. 初始化数据库

1. 右键 `trucks.schema.json` → 上传DB Schema
2. 在 uniCloud web控制台 → 云数据库 → 初始化数据库

### 4. 配置uni-id

1. 打开微信小程序后台，获取 AppID 和 AppSecret
2. 修改 `/uniCloud-aliyun/cloudfunctions/common/uni-config-center/uni-id/config.json`
3. 填入正确的 appid 和 appsecret
4. 上传公共模块

### 5. 测试

在前端调用云对象进行测试

---

## 常见问题

### Q1: 云对象调用失败？
A: 检查云函数是否已上传，是否关联了云服务空间

### Q2: 登录失败？
A: 检查 uni-id 配置中的 appid 和 appsecret 是否正确

### Q3: 权限错误？
A: 检查 schema 中的 permission 配置是否正确

### Q4: 状态没有自动流转？
A: 检查 complete 方法的逻辑，确保下一个记录被正确更新

---

## 安全建议

1. **修改密钥**：生产环境必须修改 passwordSecret 和 tokenSecret
2. **限制访问**：根据实际需求配置数据库权限和云对象权限
3. **日志记录**：添加操作日志，记录关键操作
4. **防刷保护**：添加验证码或频率限制，防止恶意登记
5. **数据备份**：定期备份数据库数据

---

## 维护建议

1. **定期清理**：定期归档或删除历史已完成记录
2. **监控告警**：配置uniCloud的监控告警功能
3. **日志分析**：定期查看云函数日志，发现潜在问题
4. **性能优化**：根据实际使用情况优化数据库索引和查询

---

## 联系方式

如有问题，请参考：
- uniCloud官方文档：https://doc.dcloud.net.cn/uniCloud/
- uni-app官方文档：https://uniapp.dcloud.net.cn/

