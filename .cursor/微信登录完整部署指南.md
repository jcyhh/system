# å¾®ä¿¡ç™»å½•å®Œæ•´éƒ¨ç½²æŒ‡å—

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäº uniCloud çš„ä»“åº“å¸è´§ç®¡ç†ç³»ç»Ÿï¼Œä½¿ç”¨å¾®ä¿¡å°ç¨‹åºç™»å½•å®ç°ç”¨æˆ·èº«ä»½éªŒè¯ã€‚

## ğŸ—‚ï¸ æ–‡ä»¶ç»“æ„

```
uniCloud-aliyun/
â”œâ”€â”€ cloudfunctions/
â”‚   â”œâ”€â”€ common/
â”‚   â”‚   â”œâ”€â”€ uni-config-center/
â”‚   â”‚   â”‚   â””â”€â”€ uni-id/
â”‚   â”‚   â”‚       â””â”€â”€ config.json          # uni-id é…ç½®æ–‡ä»¶ï¼ˆé‡è¦ï¼ï¼‰
â”‚   â”‚   â”œâ”€â”€ uni-id-common/               # uni-id æ ¸å¿ƒæ¨¡å—
â”‚   â”‚   â””â”€â”€ uni-open-bridge-common/      # å ä½æ¨¡å—
â”‚   â”œâ”€â”€ user/
â”‚   â”‚   â”œâ”€â”€ index.obj.js                 # ç”¨æˆ·äº‘å¯¹è±¡ï¼ˆå¾®ä¿¡ç™»å½•ï¼‰
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â””â”€â”€ truck/
â”‚       â”œâ”€â”€ index.obj.js                 # å¸è´§ç®¡ç†äº‘å¯¹è±¡
â”‚       â””â”€â”€ package.json
â””â”€â”€ database/
    â”œâ”€â”€ uni-id-users.schema.ext.json     # ç”¨æˆ·è¡¨æ‰©å±•ï¼ˆæ·»åŠ è§’è‰²å­—æ®µï¼‰
    â”œâ”€â”€ trucks.schema.json               # å¸è´§è®°å½•è¡¨
    â””â”€â”€ db_init.json                     # æ•°æ®åº“åˆå§‹åŒ–
```

## ğŸ”‘ æ ¸å¿ƒé…ç½®

### 1. uni-id é…ç½®æ–‡ä»¶

è·¯å¾„ï¼š`uniCloud-aliyun/cloudfunctions/common/uni-config-center/uni-id/config.json`

```json
{
  "passwordSecret": "wh5K9mP2xL8nQ4vR7jT3gF6bN1yH0zC5eW8dA2sM7uX4kV9pT6rL3",
  "tokenSecret": "aB7cD2eF9gH4iJ1kL6mN3oP8qR5sT0uV4wX7yZ2aC5bD8eF1gH6iJ3",
  "tokenExpiresIn": 7200000,
  "mp-weixin": {
    "oauth": {
      "weixin": {
        "appid": "wx93f72f4bacc468f4",
        "appsecret": "6e54ef01b2ca76c2b37fe360774ce7ae"
      }
    }
  }
}
```

**é‡è¦è¯´æ˜ï¼š**
- `passwordSecret` å’Œ `tokenSecret` å·²ç”Ÿæˆï¼Œè¯·å‹¿ä¿®æ”¹
- `appid` å’Œ `appsecret` æ˜¯æ‚¨çš„å¾®ä¿¡å°ç¨‹åºå‡­è¯
- `tokenExpiresIn` ä¸º token æœ‰æ•ˆæœŸï¼ˆ2å°æ—¶ï¼‰

### 2. manifest.json é…ç½®

è·¯å¾„ï¼š`manifest.json`

ç¡®ä¿å¾®ä¿¡å°ç¨‹åº AppID å·²é…ç½®ï¼š

```json
{
  "mp-weixin": {
    "appid": "wx93f72f4bacc468f4"
  }
}
```

## ğŸ“¦ éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤1ï¼šä¸Šä¼ å…¬å…±æ¨¡å—

1. åœ¨ HBuilderX ä¸­ï¼Œå³é”®ç‚¹å‡» `uniCloud-aliyun/cloudfunctions/common` æ–‡ä»¶å¤¹
2. é€‰æ‹© **"ä¸Šä¼ å…¬å…±æ¨¡å—"**
3. ç­‰å¾…ä¸Šä¼ å®Œæˆï¼ˆçº¦1-2åˆ†é’Ÿï¼‰

**æ³¨æ„ï¼š** å…¬å…±æ¨¡å—åŒ…å« `uni-config-center`ã€`uni-id-common`ã€`uni-open-bridge-common`

### æ­¥éª¤2ï¼šä¸Šä¼ æ•°æ®åº“è¡¨ç»“æ„

1. å³é”®ç‚¹å‡» `uniCloud-aliyun/database/uni-id-users.schema.ext.json`
2. é€‰æ‹© **"ä¸Šä¼ Schemaæ‰©å±•"**
3. å³é”®ç‚¹å‡» `trucks.schema.json`
4. é€‰æ‹© **"ä¸Šä¼ Schema"**

### æ­¥éª¤3ï¼šä¸Šä¼ äº‘å¯¹è±¡

1. å³é”®ç‚¹å‡» `uniCloud-aliyun/cloudfunctions/user` æ–‡ä»¶å¤¹
2. é€‰æ‹© **"ä¸Šä¼ éƒ¨ç½²"**
3. ç­‰å¾…ä¸Šä¼ å®Œæˆ
4. å³é”®ç‚¹å‡» `uniCloud-aliyun/cloudfunctions/truck` æ–‡ä»¶å¤¹
5. é€‰æ‹© **"ä¸Šä¼ éƒ¨ç½²"**
6. ç­‰å¾…ä¸Šä¼ å®Œæˆ

### æ­¥éª¤4ï¼šåˆå§‹åŒ–æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

1. å³é”®ç‚¹å‡» `db_init.json`
2. é€‰æ‹© **"åˆå§‹åŒ–æ•°æ®åº“"**

## ğŸš€ è¿è¡Œæµ‹è¯•

### 1. è¿è¡Œåˆ°å¾®ä¿¡å¼€å‘è€…å·¥å…·

1. åœ¨ HBuilderX ä¸­ç‚¹å‡» **è¿è¡Œ â†’ è¿è¡Œåˆ°å°ç¨‹åºæ¨¡æ‹Ÿå™¨ â†’ å¾®ä¿¡å¼€å‘è€…å·¥å…·**
2. ç­‰å¾…ç¼–è¯‘å®Œæˆ

### 2. æµ‹è¯•ç™»å½•åŠŸèƒ½

1. åœ¨å°ç¨‹åºä¸­ç‚¹å‡» **"æˆ‘çš„"** æ ‡ç­¾é¡µ
2. ç‚¹å‡» **"ç‚¹å‡»ç™»å½•"**
3. å¦‚æœç™»å½•æˆåŠŸï¼Œä¼šæ˜¾ç¤ºï¼š
   - ç”¨æˆ·è§’è‰²ï¼ˆç®¡ç†å‘˜/æ™®é€šç”¨æˆ·ï¼‰
   - ç”¨æˆ·ID

## ğŸ“± API æ¥å£è¯´æ˜

### ç”¨æˆ·ç›¸å…³æ¥å£ï¼ˆuser äº‘å¯¹è±¡ï¼‰

#### 1. å¾®ä¿¡ç™»å½•

```javascript
const userObj = uniCloud.importObject('user')
const res = await userObj.loginByWeixin({
  code: 'å¾®ä¿¡ç™»å½•code'
})
```

**å“åº”ï¼š**
```javascript
{
  errCode: 0,
  errMsg: 'ç™»å½•æˆåŠŸ',
  data: {
    token: 'xxx',
    tokenExpired: 1234567890,
    userInfo: {
      _id: 'user_id',
      uid: 'user_id',
      role: 0  // 0-æ™®é€šç”¨æˆ·, 1-ç®¡ç†å‘˜
    }
  }
}
```

#### 2. è·å–ç”¨æˆ·ä¿¡æ¯

```javascript
const userObj = uniCloud.importObject('user')
const res = await userObj.getUserInfo()
```

### å¸è´§ç®¡ç†æ¥å£ï¼ˆtruck äº‘å¯¹è±¡ï¼‰

æ‰€æœ‰ truck æ¥å£éƒ½éœ€è¦ç™»å½•åè°ƒç”¨ã€‚

#### 1. å¸æœºç™»è®°

```javascript
const truckObj = uniCloud.importObject('truck')
const res = await truckObj.register({
  driver_name: 'å¼ ä¸‰',
  phone: '13800138000',
  plate_number: 'äº¬A12345',
  truck_length: '9.6ç±³',
  loading_place: 'åŒ—äº¬',
  arrival_time: Date.now(),
  arrival_photo: 'cloud://xxx.jpg'
})
```

#### 2. å®Œæˆå¸è´§

```javascript
const res = await truckObj.complete({
  id: 'record_id',
  unload_time: Date.now(),
  unload_photo: 'cloud://xxx.jpg'
})
```

#### 3. è·å–å½“å‰ä»»åŠ¡

```javascript
const res = await truckObj.getCurrentTask()
```

#### 4. è·å–æˆ‘çš„å†å²è®°å½•

```javascript
const res = await truckObj.getMyRecords({
  page: 1,
  pageSize: 20
})
```

#### 5. è·å–åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ï¼‰

```javascript
const res = await truckObj.getList({
  status: 0,  // 0-æ’é˜Ÿä¸­ï¼Œ1-å¤„ç†ä¸­ï¼Œ2-å·²å®Œæˆ
  page: 1,
  pageSize: 20
})
```

#### 6. è·å–é˜Ÿåˆ—ç»Ÿè®¡

```javascript
const res = await truckObj.getQueueStats()
```

## ğŸ” æƒé™è¯´æ˜

### ç”¨æˆ·è§’è‰²

- **role: 0** - æ™®é€šç”¨æˆ·ï¼ˆå¸æœºï¼‰
  - å¯ä»¥ç™»è®°å¸è´§
  - å¯ä»¥å®Œæˆè‡ªå·±çš„å¸è´§è®°å½•
  - å¯ä»¥æŸ¥çœ‹è‡ªå·±çš„è®°å½•

- **role: 1** - ç®¡ç†å‘˜
  - æ‹¥æœ‰æ‰€æœ‰æ™®é€šç”¨æˆ·æƒé™
  - å¯ä»¥æŸ¥çœ‹æ‰€æœ‰è®°å½•
  - å¯ä»¥æŸ¥çœ‹ç»Ÿè®¡æ•°æ®

### æ•°æ®è¡¨æƒé™

**uni-id-users è¡¨ï¼š**
- ç”± uni-id è‡ªåŠ¨ç®¡ç†

**trucks è¡¨ï¼š**
- è¯»å–ï¼šéœ€è¦ç™»å½•
- åˆ›å»ºï¼šéœ€è¦ç™»å½•
- æ›´æ–°ï¼šä»…è®°å½•æ‰€æœ‰è€…å¯æ›´æ–°
- åˆ é™¤ï¼šç¦æ­¢

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å…¬å…±æ¨¡å—å¿…é¡»ä¸Šä¼ 

å¦‚æœé‡åˆ° "Invalid uni-id config file" é”™è¯¯ï¼Œè¯´æ˜å…¬å…±æ¨¡å—æœªä¸Šä¼ æˆ–é…ç½®æ–‡ä»¶æœ‰è¯¯ã€‚

**è§£å†³æ–¹æ³•ï¼š**
- ç¡®ä¿ `common` æ–‡ä»¶å¤¹å·²ä¸Šä¼ 
- æ£€æŸ¥ `uni-id/config.json` æ˜¯å¦ä¸ºæ ‡å‡† JSON æ ¼å¼ï¼ˆä¸èƒ½æœ‰æ³¨é‡Šï¼‰
- åœ¨ uniCloud Web æ§åˆ¶å°æ£€æŸ¥å…¬å…±æ¨¡å—æ˜¯å¦å­˜åœ¨

### 2. Token è‡ªåŠ¨ç®¡ç†

uni-app æ¡†æ¶ä¼šè‡ªåŠ¨ç®¡ç† tokenï¼š
- ç™»å½•æˆåŠŸåè‡ªåŠ¨ä¿å­˜ token
- æ¯æ¬¡è¯·æ±‚è‡ªåŠ¨æºå¸¦ token
- token è¿‡æœŸè‡ªåŠ¨åˆ·æ–°

### 3. å¾®ä¿¡å°ç¨‹åºåˆæ³•åŸŸå

éœ€è¦åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°é…ç½®ä»¥ä¸‹åˆæ³•åŸŸåï¼š
- `https://api.next.bspapp.com`ï¼ˆuniCloud é˜¿é‡Œäº‘åŸŸåï¼‰

### 4. æµ‹è¯•è´¦å·

é¦–æ¬¡ç™»å½•ä¼šè‡ªåŠ¨åˆ›å»ºç”¨æˆ·ï¼Œé»˜è®¤ä¸ºæ™®é€šç”¨æˆ·ï¼ˆrole: 0ï¼‰ã€‚

å¦‚éœ€åˆ›å»ºç®¡ç†å‘˜è´¦å·ï¼š
1. ç™»å½•åè·å–ç”¨æˆ·ID
2. åœ¨ uniCloud Web æ§åˆ¶å°æ‰“å¼€ `uni-id-users` è¡¨
3. æ‰¾åˆ°è¯¥ç”¨æˆ·è®°å½•ï¼Œå°† `role` å­—æ®µæ”¹ä¸º `1`

## ğŸ› å¸¸è§é—®é¢˜

### Q1: ç™»å½•æ—¶æç¤º "Invalid uni-id config file"

**A:** å…¬å…±æ¨¡å—æœªä¸Šä¼ æˆ–é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯ã€‚
- é‡æ–°ä¸Šä¼  `common` å…¬å…±æ¨¡å—
- æ£€æŸ¥ `config.json` æ˜¯å¦ä¸ºæ ‡å‡† JSONï¼ˆæ— æ³¨é‡Šï¼‰

### Q2: ç™»å½•æˆåŠŸä½†æ— æ³•è°ƒç”¨ truck æ¥å£

**A:** token æœªæ­£ç¡®ä¼ é€’ã€‚
- æ£€æŸ¥å‰ç«¯æ˜¯å¦æ­£ç¡®ä¿å­˜äº† token
- ä½¿ç”¨ `uniCloud.importObject()` ä¼šè‡ªåŠ¨ä¼ é€’ token

### Q3: å¦‚ä½•è®¾ç½®ç®¡ç†å‘˜

**A:** åœ¨æ•°æ®åº“ä¸­æ‰‹åŠ¨ä¿®æ”¹ç”¨æˆ·çš„ `role` å­—æ®µä¸º `1`

### Q4: é˜Ÿåˆ—é€»è¾‘å¦‚ä½•å·¥ä½œ

**A:** 
1. é¦–ä¸ªç™»è®°çš„å¸æœºè‡ªåŠ¨å˜ä¸º"å¤„ç†ä¸­"çŠ¶æ€
2. åç»­ç™»è®°çš„å¸æœºä¸º"æ’é˜Ÿä¸­"çŠ¶æ€
3. å½“"å¤„ç†ä¸­"çš„å¸æœºå®Œæˆå¸è´§åï¼Œé˜Ÿåˆ—ä¸­æœ€æ—©çš„è‡ªåŠ¨å˜ä¸º"å¤„ç†ä¸­"

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- [uniCloud å®˜æ–¹æ–‡æ¡£](https://doc.dcloud.net.cn/uniCloud/)
- [uni-id å®˜æ–¹æ–‡æ¡£](https://doc.dcloud.net.cn/uniCloud/uni-id/summary.html)

---

**æœ€åæ›´æ–°ï¼š** 2026-01-10

