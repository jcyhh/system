# 微信订阅消息配置说明

## 📋 功能概述

系统已集成微信订阅消息功能，在以下关键节点会自动通知用户：

1. **排队成功提醒** - 司机提交申请后，如果需要排队
2. **排队到号通知** - 轮到司机时（状态变为"处理中"）
3. **排队进度通知** - 预留功能（可用于前面车辆减少时提醒）

---

## 🔧 配置步骤

### 第1步：微信小程序后台配置

1. 登录 [微信小程序后台](https://mp.weixin.qq.com/)
2. 进入 **功能** → **订阅消息**
3. 你已添加的3个模板：

| 模板名称 | 模板ID | 使用场景 |
|---------|--------|---------|
| 排队到号通知 | `6dmIz67zTI9aE3PJCTrqK48vFvZOctRJDTnzFx0Wj2M` | 用户提交申请时通知 |
| 排队进度通知 | `dKt-GXFHtyyoN_6Ag-ulck-eafezp1bQ6Sz95QCu6nM` | 有人完成后，前面≤3人时通知 |
| 排队成功提醒 | `7WbkjjD-w6tc28gX2Gn8-dWCQreta-M-Y5LltkXm3sk` | 排队中→处理中时通知 |

### 第2步：代码中的模板ID

已在 `/pages/home/apply.vue` 中配置：

```javascript
const tmplIds = [
  '6dmlz67zTl9aE3PJCTrqK48vFvZOctRJDTnz',  // 排队到号通知
  'dKt-GXFHtyyoN_6Ag-ulck-eafezp1bQ6Sz95',  // 排队进度通知
  '7WbkijD-w6tc28gX2Gn8-dWCQreta-M-Y5LI'   // 排队成功提醒
]
```

**⚠️ 注意**：如果你更换了模板，需要同步修改以下位置：
1. `/pages/home/apply.vue` 的 `requestSubscribe` 方法（3个模板ID）
2. `/uniCloud-aliyun/cloudfunctions/truck/index.obj.js` 的 `register` 方法（1个模板ID）
3. `/uniCloud-aliyun/cloudfunctions/truck/index.obj.js` 的 `complete` 方法（2个模板ID）

---

## 🔄 业务流程

### 1. 用户提交申请

```
用户填写表单 
  ↓
请求订阅消息权限（弹出授权框）
  ↓
用户授权（允许/拒绝某些模板）
  ↓
提交申请到服务器
  ↓
服务器保存用户订阅的模板ID
```

### 2. 发送通知的时机

**场景A：用户提交申请时（无论什么状态）**
```
发送：排队到号通知
内容：
  - 直接处理中：您的车辆已开始处理
  - 需要排队：您已成功排队，前面还有X辆车
```

**场景B：前面的车完成后，下一个排队中变为处理中**
```
发送：排队成功提醒
内容：轮到您了，请准备装卸货！
```

**场景C：有车完成后，排队数量变化，前面≤3人**
```
发送：排队进度通知
内容：车牌号XXX，当前等待人数：X
```

---

## 🛠️ 技术实现

### 前端（apply.vue）

1. **申请授权**：
```javascript
uni.requestSubscribeMessage({
  tmplIds: [...],
  success: (res) => {
    // 记录用户授权的模板
  }
})
```

2. **提交时携带订阅信息**：
```javascript
await truckObj.register({
  ...formData,
  subscribedTmpls: subscribedTmpls // 传递授权的模板ID
})
```

### 后端（truck/index.obj.js）

1. **获取access_token**：
```javascript
async getAccessToken() {
  // 从uni-id配置读取appid和appsecret
  // 调用微信API获取access_token
}
```

2. **发送订阅消息**：
```javascript
async sendSubscribeMessage(userId, taskId, templateId, data) {
  // 获取用户openid
  // 检查用户是否订阅了该模板
  // 调用微信API发送消息
}
```

3. **在关键节点调用**：
- `register()` 方法：提交申请时，发送"排队到号通知"
- `complete()` 方法：
  - 下一个变为处理中时，发送"排队成功提醒"
  - 前面≤3人的排队用户，发送"排队进度通知"

---

## 📊 数据库字段

### trucks 表新增字段

```json
{
  "subscribed_tmpls": {
    "bsonType": "array",
    "description": "用户订阅的消息模板ID列表",
    "items": {
      "bsonType": "string"
    }
  }
}
```

**说明**：保存用户授权的模板ID，发送消息前会检查用户是否订阅了该模板

---

## 🚀 部署步骤

### 1. 上传数据库表结构

1. 右键 `trucks.schema.json`
2. 选择 **上传Schema扩展到云端**

### 2. 上传云对象

1. 右键 `truck` 云对象目录
2. 选择 **上传并部署**

### 3. 前端代码

小程序代码会自动编译，无需额外操作

---

## ⚠️ 注意事项

### 1. 用户授权

- 用户可以选择性授权某些模板，也可以全部拒绝
- 即使用户拒绝授权，业务逻辑不受影响，只是不会收到通知
- 用户一次最多授权3个模板

### 2. 消息发送限制

- **一次性订阅**：每个模板只能发送一次，发送后订阅失效
- **频率限制**：微信会限制消息发送频率，避免骚扰用户
- **内容限制**：消息内容必须符合模板字段定义

### 3. 模板字段映射

**排队到号通知** (6dmIz67zTI9aE3PJCTrqK48vFvZOctRJDTnzFx0Wj2M)
- 使用时机：用户提交申请时
```javascript
{
  character_string1: { value: '车牌号' },  // 车牌号
  thing2: { value: '备注说明' }           // 备注说明（处理中/排队中状态）
}
```

**排队成功提醒** (7WbkjjD-w6tc28gX2Gn8-dWCQreta-M-Y5LltkXm3sk)
- 使用时机：排队中→处理中时
```javascript
{
  character_string1: { value: '车牌号' },        // 车牌号
  thing3: { value: '轮到您了' },                // 前面还有
  thing5: { value: '请准备装卸货！' }            // 温馨提示
}
```

**排队进度通知** (dKt-GXFHtyyoN_6Ag-ulck-eafezp1bQ6Sz95QCu6nM)
- 使用时机：有人完成后，前面≤3人时
```javascript
{
  character_string1: { value: '车牌号' },        // 车牌号
  number2: { value: '3' },                      // 当前等待人数（1/2/3）
  thing3: { value: '即将排到您，请做好准备' }    // 温馨提示
}
```
**⚠️ 注意**：请确保该模板在微信后台有 `thing3` 字段，如果没有，请调整为实际的字段名。

### 4. 测试环境

在测试时，需要修改 `sendSubscribeMessage` 方法中的 `miniprogram_state`：

```javascript
miniprogram_state: 'developer'  // 开发版
// 或
miniprogram_state: 'trial'      // 体验版
// 或
miniprogram_state: 'formal'     // 正式版（默认）
```

---

## 🐛 常见问题

### Q1：用户授权后仍收不到消息？

**排查步骤**：
1. 检查用户是否授权了该模板（查看 `trucks` 表的 `subscribed_tmpls` 字段）
2. 检查用户的 `wx_openid.mp` 字段是否正确
3. 查看云函数日志，确认是否调用了发送方法
4. 检查微信 access_token 是否获取成功
5. 确认模板ID是否正确

### Q2：发送失败，errcode: 43101？

**原因**：用户拒绝了该模板的订阅
**解决**：这是正常情况，用户有权拒绝接收通知

### Q3：发送失败，errcode: 40037？

**原因**：模板ID不存在或已被删除
**解决**：检查模板ID是否正确，或重新添加模板

### Q4：发送失败，errcode: 47003？

**原因**：模板参数不正确
**解决**：检查传递的数据字段是否与模板定义一致

### Q5：access_token 获取失败？

**原因**：AppID 或 AppSecret 配置错误
**解决**：检查 `uni-id/config.json` 中的配置是否正确

---

## 📝 后续优化建议

1. **access_token 缓存**：
   - 目前每次发送消息都获取新的 access_token
   - 建议缓存 access_token（有效期2小时）
   - 可使用 redis 或数据库存储

2. **消息队列**：
   - 当需要批量发送消息时，建议使用消息队列
   - 避免同时发送大量消息导致接口限流

3. **发送记录**：
   - 建议创建 `message_logs` 表记录消息发送历史
   - 便于排查问题和统计分析

4. **重试机制**：
   - 当发送失败时，可以实现重试机制
   - 注意避免无限重试导致资源浪费

---

## 📞 技术支持

如遇到问题，可以：
1. 查看微信官方文档：https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/subscribe-message/subscribeMessage.send.html
2. 查看 uniCloud 文档：https://uniapp.dcloud.net.cn/uniCloud/
3. 检查云函数日志获取错误详情
