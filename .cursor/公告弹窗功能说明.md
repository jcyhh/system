# 公告弹窗功能说明

## 功能概述

用户登录后进入首页时，系统会自动检查是否有需要弹窗展示的公告。如果有未读的弹窗公告，会自动弹出显示。用户点击"我已知晓"后，该公告将不再弹出。

---

## 数据库表结构变更

### 1. `notices` 表新增字段

```json
{
  "is_popup": {
    "bsonType": "bool",
    "label": "是否弹窗展示",
    "description": "用户进入首页时是否弹窗展示",
    "defaultValue": false
  }
}
```

### 2. `uni-id-users` 表新增字段

```json
{
  "read_popup_notices": {
    "bsonType": "array",
    "description": "已读的弹窗公告ID列表",
    "title": "已读弹窗公告"
  }
}
```

---

## 云函数接口

### 1. 获取弹窗公告

**方法名**: `getPopupNotice`

**请求参数**: 无

**返回数据**:
```javascript
{
  errCode: 0,
  errMsg: '获取成功',
  data: {
    _id: '公告ID',
    title: '公告标题',
    content: '公告内容（支持HTML）',
    create_time: 1737014400000,
    is_published: true,
    is_popup: true
  }
}
```

**说明**:
- 需要用户登录
- 自动过滤已读的弹窗公告
- 返回最新的一条未读弹窗公告
- 如果没有未读公告，返回 `data: null`

---

### 2. 标记公告为已读

**方法名**: `markPopupAsRead`

**请求参数**:
```javascript
{
  noticeId: '公告ID'
}
```

**返回数据**:
```javascript
{
  errCode: 0,
  errMsg: '标记成功'
}
```

**说明**:
- 需要用户登录
- 将公告ID添加到用户的 `read_popup_notices` 数组中
- 下次获取弹窗公告时会自动过滤该公告

---

## 前端实现

### 1. 首页加载流程

```typescript
onShow(async () => {
  // 1. 加载公告列表（轮播用）
  await loadNoticeList()
  
  // 2. 加载排队列表
  await loadQueueList(true)
  
  // 3. 检查当前任务
  await checkCurrentTask()
  
  // 4. 检查弹窗公告（需要登录）
  await loadPopupNotice()
})
```

### 2. 弹窗展示逻辑

- 只有登录用户才会检查弹窗公告
- 延迟 500ms 展示，避免页面加载时立即弹出
- 弹窗不可通过点击遮罩关闭（`mask-click="false"`）
- 必须点击"我已知晓"按钮才能关闭

### 3. 用户点击"我已知晓"

- 调用 `markPopupAsRead` 接口标记已读
- 关闭弹窗
- 下次进入首页不再弹出该公告

---

## 使用示例

### 添加弹窗公告数据

在云数据库 `notices` 表中添加记录：

```json
{
  "title": "入院须知",
  "content": "1. 院内严禁吸烟，违者罚款1000元\n\n2. 卸完货请点击完成并上传照片\n\n3. 单据在拐角处一楼第三个房间办公室签字",
  "is_published": true,
  "is_popup": true
}
```

**字段说明**:
- `title`: 必填，公告标题
- `content`: 必填，公告内容，支持纯文本或 HTML 格式
- `is_published`: 必须为 `true`，否则不会显示（默认为 `true`）
- `is_popup`: 必须为 `true`，否则不会弹窗（默认为 `false`）
- `create_time`: 自动生成，无需手动填写
- `update_time`: 自动生成，无需手动填写

---

## 测试流程

1. **上传云函数**
   - 右键 `notice` 文件夹 → 上传并部署

2. **添加测试数据**
   - 打开云数据库管理
   - 选择 `notices` 表
   - 点击"添加记录"
   - 粘贴上面的 JSON 数据

3. **测试弹窗**
   - 登录小程序
   - 进入首页
   - 应该会自动弹出公告

4. **测试已读**
   - 点击"我已知晓"
   - 关闭小程序
   - 重新打开进入首页
   - 不应该再弹出该公告

5. **查看已读记录**
   - 打开云数据库 `uni-id-users` 表
   - 查看对应用户的 `read_popup_notices` 字段
   - 应该包含刚才已读的公告ID

---

## 注意事项

1. **弹窗公告优先级**
   - 系统只会弹出最新的一条未读弹窗公告
   - 如果有多条未读弹窗公告，会按创建时间倒序展示
   - 用户点击"我已知晓"后，下次进入会弹出下一条未读公告

2. **HTML 内容支持**
   - `content` 字段使用 `v-html` 渲染
   - 可以使用 HTML 标签进行格式化
   - 示例：`<p><strong>加粗文本</strong></p>`

3. **已读记录**
   - 已读记录存储在用户表的 `read_popup_notices` 数组中
   - 使用 `dbCmd.addToSet` 避免重复添加
   - 不会自动清除，用户会永久记录已读状态

4. **性能优化**
   - 弹窗公告延迟 500ms 展示
   - 只有登录用户才会加载弹窗公告
   - 不会影响首页主要功能的加载速度
