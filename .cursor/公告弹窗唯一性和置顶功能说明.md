# 公告弹窗唯一性和置顶功能说明

## 功能概述

实现了以下三个优化：

1. **弹窗唯一性**：同一时间只能有一条弹窗公告
2. **弹窗置顶**：弹窗公告在列表中自动置顶显示
3. **时间显示修复**：确保新增公告正确显示创建时间

---

## 1. 弹窗唯一性

### 业务规则

- ✅ 同一时间只能有一条弹窗公告
- ✅ 新设置弹窗时，自动取消其他公告的弹窗状态
- ✅ 编辑公告设置为弹窗时，自动取消其他公告的弹窗状态

### 实现逻辑

#### 新增公告时

```javascript
// 如果设置为弹窗，先将其他弹窗公告改为非弹窗
if (is_popup === true) {
  await db.collection('notices').where({
    is_popup: true
  }).update({
    is_popup: false
  });
  console.log('✅ 已将其他弹窗公告改为非弹窗');
}
```

#### 编辑公告时

```javascript
// 如果设置为弹窗，先将其他弹窗公告改为非弹窗（排除当前公告）
if (is_popup === true) {
  await db.collection('notices').where({
    _id: dbCmd.neq(id),  // 排除当前公告
    is_popup: true
  }).update({
    is_popup: false
  });
  console.log('✅ 已将其他弹窗公告改为非弹窗');
}
```

### 使用场景

**场景 1：创建新的弹窗公告**

```
操作前：
- 公告A：is_popup = true  ✅ 弹窗
- 公告B：is_popup = false

操作：创建公告C，设置 is_popup = true

操作后：
- 公告A：is_popup = false  ❌ 自动取消
- 公告B：is_popup = false
- 公告C：is_popup = true   ✅ 新的弹窗
```

**场景 2：编辑公告为弹窗**

```
操作前：
- 公告A：is_popup = true  ✅ 弹窗
- 公告B：is_popup = false

操作：编辑公告B，设置 is_popup = true

操作后：
- 公告A：is_popup = false  ❌ 自动取消
- 公告B：is_popup = true   ✅ 新的弹窗
```

---

## 2. 弹窗公告置顶

### 排序规则

列表排序逻辑：
1. **第一优先级**：弹窗公告（`is_popup = true`）在前
2. **第二优先级**：按创建时间倒序（最新的在前）

### 实现逻辑

```javascript
// 自定义排序：弹窗公告置顶，然后按创建时间倒序
let sortedList = allResult.data.sort((a, b) => {
  // 先按是否弹窗排序（弹窗在前）
  if (a.is_popup && !b.is_popup) return -1;
  if (!a.is_popup && b.is_popup) return 1;
  // 相同弹窗状态，按创建时间倒序
  return b.create_time - a.create_time;
});
```

### 显示效果

**管理员视图**：

```
┌─────────────────────────────────────┐
│ 📌 入院须知          [弹窗]          │  ← 弹窗公告置顶
│ 2025-01-16 16:00     ✏️  🗑️        │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 本周营业时间调整                      │  ← 普通公告
│ 2025-01-15 14:00     ✏️  🗑️        │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 春节放假通知                          │  ← 普通公告
│ 2025-01-14 10:00     ✏️  🗑️        │
└─────────────────────────────────────┘
```

**说明**：
- 弹窗公告永远显示在最上面
- 即使创建时间较早，也会置顶
- 多个普通公告按时间倒序排列

---

## 3. 时间显示修复

### 问题原因

之前在云函数中删除了时间戳的手动设置，依赖数据库的 `forceDefaultValue` 自动生成。但在某些情况下可能不生效，导致时间显示为 `NaN-NaN-NaN NaN:NaN`。

### 解决方案

在云函数中手动设置时间戳，确保时间字段正确生成：

#### 新增公告

```javascript
const now = Date.now();
const addData = {
  title,
  content,
  user_id: payload.uid,
  is_published: is_published !== undefined ? is_published : true,
  is_popup: is_popup !== undefined ? is_popup : false,
  create_time: now,      // ✅ 手动设置创建时间
  update_time: now       // ✅ 手动设置更新时间
};
```

#### 编辑公告

```javascript
const updateData = {
  update_time: Date.now()  // ✅ 手动更新时间
};
if (title !== undefined) updateData.title = title;
if (content !== undefined) updateData.content = content;
// ... 其他字段
```

### 时间格式

- **存储格式**：时间戳（毫秒）
- **显示格式**：`2025-01-16 16:00`
- **前端处理**：使用 `formatTime` 函数格式化

---

## 📊 完整流程示例

### 示例：管理员创建弹窗公告

**初始状态**：
```
公告列表：
1. 营业时间调整 (2025-01-15 14:00, 普通公告)
2. 春节放假通知 (2025-01-14 10:00, 普通公告)
```

**操作步骤**：
1. 管理员点击"添加公告"
2. 填写标题："入院须知"
3. 填写内容："1. 禁止吸烟..."
4. 开启"是否弹窗展示"开关
5. 点击"创建公告"

**系统处理**：
```javascript
1. 检测到 is_popup = true
2. 查找并取消其他弹窗公告（如果有）
3. 创建新公告，设置 create_time 和 update_time
4. 返回列表页
```

**结果状态**：
```
公告列表（自动刷新后）：
1. 📌 入院须知 (2025-01-16 16:00, [弹窗])  ← 新建，置顶
2. 营业时间调整 (2025-01-15 14:00)
3. 春节放假通知 (2025-01-14 10:00)
```

---

## 🔧 技术细节

### 数据库查询优化

**之前的做法**：
```javascript
// 使用 orderBy + skip + limit
const result = await db.collection('notices')
  .where(where)
  .orderBy('create_time', 'desc')
  .skip((page - 1) * pageSize)
  .limit(pageSize)
  .get();
```

**问题**：
- 数据库不支持多字段排序
- 无法实现"先按弹窗排序，再按时间排序"

**现在的做法**：
```javascript
// 获取所有数据后在内存中排序
const allResult = await db.collection('notices')
  .where(where)
  .get();

let sortedList = allResult.data.sort((a, b) => {
  if (a.is_popup && !b.is_popup) return -1;
  if (!a.is_popup && b.is_popup) return 1;
  return b.create_time - a.create_time;
});

// 然后手动分页
const paginatedList = sortedList.slice(startIndex, endIndex);
```

**优点**：
- ✅ 实现了复杂的排序逻辑
- ✅ 弹窗公告自动置顶
- ✅ 时间排序正确

**注意**：
- ⚠️ 数据量大时可能影响性能
- 💡 如果公告数量超过几百条，建议改用数据库索引优化

---

## 📱 用户体验

### 管理员体验

1. **创建弹窗公告**：
   - 开启"是否弹窗展示"
   - 保存后自动置顶
   - 其他弹窗自动取消
   - 不需要手动管理唯一性

2. **编辑弹窗公告**：
   - 修改内容后仍然置顶
   - 清除所有用户已读记录
   - 确保用户看到最新内容

3. **查看列表**：
   - 弹窗公告一目了然（置顶 + 蓝色标签）
   - 按时间倒序，最新的在前
   - 可以看到所有公告（包括未发布的）

### 普通用户体验

1. **查看列表**：
   - 弹窗公告置顶
   - 按时间排序
   - 只能看到已发布的公告

2. **接收弹窗**：
   - 登录时自动弹出最新的弹窗公告
   - 点击"我已知晓"后不再弹出
   - 公告编辑后会重新弹出

---

## ⚠️ 注意事项

### 1. 弹窗唯一性

- ✅ 系统自动保证唯一性
- ✅ 管理员无需手动管理
- ⚠️ 设置新弹窗会自动取消旧弹窗
- 💡 建议：在设置弹窗前，确认是否要取消当前弹窗

### 2. 置顶排序

- ✅ 弹窗公告永远在最前面
- ✅ 即使创建时间较早也会置顶
- ✅ 普通公告按时间倒序
- 💡 建议：重要公告可以设置为弹窗，确保用户看到

### 3. 时间显示

- ✅ 所有新建和编辑的公告都会正确显示时间
- ✅ 时间格式为 `年-月-日 时:分`
- ⚠️ 如果看到 `NaN-NaN-NaN`，说明数据有问题
- 💡 解决：重新编辑保存该公告

### 4. 性能考虑

- ✅ 当前实现适合公告数量 < 500 条
- ⚠️ 数据量大时，查询所有数据可能较慢
- 💡 优化方案：
  - 方案1：在数据库中添加 `sort_order` 字段
  - 方案2：分别查询弹窗和非弹窗公告
  - 方案3：使用缓存

---

## 🚀 部署说明

### 1. 上传云函数

```bash
右键 notice 文件夹 → 上传并部署
```

### 2. 测试步骤

#### 测试弹窗唯一性

1. 创建公告A，开启弹窗
2. 创建公告B，开启弹窗
3. 验证：公告A的弹窗状态自动取消 ✅

#### 测试置顶功能

1. 创建几条普通公告
2. 创建一条弹窗公告（创建时间最晚）
3. 验证：弹窗公告显示在最上面 ✅

#### 测试时间显示

1. 创建新公告
2. 验证：显示正确的创建时间 ✅
3. 编辑公告
4. 验证：显示正确的更新时间 ✅

### 3. 查看日志

云函数日志会输出：
```
✅ 已将其他弹窗公告改为非弹窗
```

---

## 📝 总结

### 实现的功能

1. ✅ **弹窗唯一性**：自动保证同时只有一条弹窗公告
2. ✅ **弹窗置顶**：弹窗公告在列表中自动置顶
3. ✅ **时间显示**：修复时间显示问题，确保正确显示

### 优势

- ✅ 自动化管理，无需手动操作
- ✅ 用户体验好，重要公告一目了然
- ✅ 确保时间正确显示
- ✅ 有日志记录，便于追踪

### 适用场景

- ✅ 公告数量 < 500 条
- ✅ 需要置顶重要公告
- ✅ 同时只需一条弹窗公告
- ✅ 需要确保用户看到最新信息
