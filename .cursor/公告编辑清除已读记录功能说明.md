# 公告编辑清除已读记录功能说明

## 功能概述

当管理员编辑一条弹窗公告后，系统会自动清除所有用户对该公告的"已知晓"记录，确保用户能够重新看到更新后的公告内容。

---

## 业务场景

### 问题场景

1. 管理员发布了一条弹窗公告："入院须知"
2. 用户 A、B、C 登录后看到弹窗，点击"我已知晓"
3. 管理员发现公告内容有误，需要修改
4. **问题**：如果不清除已读记录，用户 A、B、C 将无法看到修改后的重要内容

### 解决方案

✅ 管理员编辑公告后，自动清除所有用户的已读记录
- 用户下次登录时会重新看到弹窗
- 确保重要信息更新不遗漏
- 避免用户基于旧信息行事

---

## 技术实现

### 云函数逻辑（`notice/index.obj.js`）

#### 更新公告时的处理流程

```javascript
async update(params) {
  // 1. 验证权限
  // 2. 更新公告内容
  await db.collection('notices').doc(id).update(updateData);
  
  // 3. 检查是否为弹窗公告
  const noticeInfo = await db.collection('notices').doc(id).get();
  if (noticeInfo.data[0] && noticeInfo.data[0].is_popup) {
    // 4. 清除所有用户的已读记录
    await db.collection('uni-id-users').where({
      read_popup_notices: dbCmd.elemMatch(dbCmd.eq(id))
    }).update({
      read_popup_notices: dbCmd.pull(id)
    });
  }
  
  return { errCode: 0, errMsg: '更新成功' };
}
```

---

## 实现细节

### 1. 判断是否为弹窗公告

```javascript
const noticeInfo = await db.collection('notices').doc(id).get();
if (noticeInfo.data[0] && noticeInfo.data[0].is_popup) {
  // 只有弹窗公告才需要清除已读记录
}
```

**说明**:
- 获取更新后的公告信息
- 检查 `is_popup` 字段
- 只有弹窗公告才执行清除操作

---

### 2. 查找有已读记录的用户

```javascript
await db.collection('uni-id-users').where({
  read_popup_notices: dbCmd.elemMatch(dbCmd.eq(id))
})
```

**说明**:
- 使用 `elemMatch` 查找数组中包含该公告 ID 的用户
- 只查询有已读记录的用户，提高效率

---

### 3. 清除已读记录

```javascript
.update({
  read_popup_notices: dbCmd.pull(id)
})
```

**说明**:
- 使用 `dbCmd.pull` 从数组中移除指定元素
- 所有匹配的用户都会被更新
- 操作是批量的，效率高

---

## 使用示例

### 场景 1：修改公告内容

**操作前**:
```
公告: "入院须知 - 禁止吸烟"
用户A: 已读 [公告ID]
用户B: 已读 [公告ID]
用户C: 已读 [公告ID]
```

**管理员操作**:
1. 编辑公告，修改为："入院须知 - 禁止吸烟，罚款1000元"
2. 保存

**操作后**:
```
公告: "入院须知 - 禁止吸烟，罚款1000元"
用户A: 已读 [] ← 已清除
用户B: 已读 [] ← 已清除
用户C: 已读 [] ← 已清除
```

**结果**:
- 用户 A、B、C 下次登录时会重新看到弹窗
- 确保用户了解最新的罚款规定

---

### 场景 2：修改普通公告（非弹窗）

**操作前**:
```
公告: "营业时间调整"
is_popup: false
```

**管理员操作**:
1. 编辑公告内容
2. 保存

**操作后**:
```
公告: "营业时间调整为9:00-18:00"
is_popup: false
用户已读记录: 不变 ← 因为不是弹窗公告
```

**结果**:
- 不清除已读记录
- 普通公告不会弹窗，无需清除

---

### 场景 3：将普通公告改为弹窗公告

**操作前**:
```
公告: "春节放假通知"
is_popup: false
```

**管理员操作**:
1. 编辑公告
2. 将 `is_popup` 改为 `true`
3. 保存

**操作后**:
```
公告: "春节放假通知"
is_popup: true ← 改为弹窗
所有用户已读记录: 已清除
```

**结果**:
- 所有用户下次登录会看到弹窗
- 即使之前在列表页看过，也会弹窗提醒

---

## 数据库操作说明

### 用户表结构（`uni-id-users`）

```javascript
{
  _id: "用户ID",
  role: 0,  // 0-普通用户，1-管理员
  read_popup_notices: ["公告ID1", "公告ID2", ...]  // 已读的弹窗公告列表
}
```

### 清除操作

**操作前**:
```javascript
// 用户 A
{
  _id: "user_a",
  read_popup_notices: ["notice_1", "notice_2", "notice_3"]
}

// 用户 B
{
  _id: "user_b",
  read_popup_notices: ["notice_2", "notice_4"]
}
```

**执行清除** (假设编辑了 `notice_2`):
```javascript
await db.collection('uni-id-users').where({
  read_popup_notices: dbCmd.elemMatch(dbCmd.eq("notice_2"))
}).update({
  read_popup_notices: dbCmd.pull("notice_2")
});
```

**操作后**:
```javascript
// 用户 A
{
  _id: "user_a",
  read_popup_notices: ["notice_1", "notice_3"]  // 移除了 notice_2
}

// 用户 B
{
  _id: "user_b",
  read_popup_notices: ["notice_4"]  // 移除了 notice_2
}
```

---

## 日志输出

清除成功后会在云函数日志中输出：

```
✅ 已清除公告 69684563eef9cb29980392aa 的所有用户已读记录
```

**说明**:
- 方便管理员确认操作成功
- 可以追踪公告编辑历史
- 便于问题排查

---

## 注意事项

### 1. 只影响弹窗公告

- ✅ 只有 `is_popup: true` 的公告才会清除已读记录
- ❌ 普通公告（`is_popup: false`）不会清除
- 📝 避免不必要的数据库操作

### 2. 批量操作性能

- ✅ 使用批量更新，一次性清除所有用户
- ✅ 只查询有已读记录的用户，提高效率
- ✅ 数据库层面操作，性能高

### 3. 用户体验

- ✅ 用户会重新看到弹窗，确保信息不遗漏
- ⚠️ 频繁编辑会导致用户多次看到弹窗，请谨慎编辑
- 💡 建议：编辑前仔细确认内容，避免多次修改

### 4. 删除公告

- 🔍 **问题**：如果删除公告，用户的已读记录怎么办？
- 💡 **答案**：不需要清除
  - 删除后公告不存在
  - `getPopupNotice` 不会返回已删除的公告
  - 用户记录保留也不影响功能
  - 减少不必要的数据库操作

---

## 测试场景

### 测试步骤

1. **准备**：
   - 使用管理员账号创建一条弹窗公告
   - 使用普通用户账号登录，看到弹窗
   - 点击"我已知晓"
   - 退出重新登录，确认不再弹窗

2. **编辑公告**：
   - 使用管理员账号编辑该公告内容
   - 保存成功

3. **验证**：
   - 使用普通用户账号重新登录
   - 应该重新看到弹窗
   - 内容为修改后的内容

4. **检查数据库**：
   - 查看 `uni-id-users` 表
   - 该用户的 `read_popup_notices` 数组中不应包含该公告 ID

---

## 常见问题

### Q1: 编辑普通公告会清除已读记录吗？

**A**: 不会。只有弹窗公告（`is_popup: true`）才会清除。

---

### Q2: 如果只修改公告的标题，不修改内容，会清除吗？

**A**: 会。只要执行了 `update` 操作，且该公告是弹窗公告，就会清除所有已读记录。

---

### Q3: 清除操作失败会影响公告更新吗？

**A**: 不会。清除操作在公告更新之后执行，即使清除失败，公告也已成功更新。但建议查看云函数日志确认清除是否成功。

---

### Q4: 用户量很大时，性能会受影响吗？

**A**: 不会有明显影响。
- 使用批量更新，效率高
- 只查询有已读记录的用户
- 数据库层面操作，性能好

---

### Q5: 能否只清除部分用户的已读记录？

**A**: 当前实现是清除所有用户。如需部分清除，需要修改云函数逻辑，根据条件筛选用户。

---

## 总结

✅ **功能特点**:
- 自动清除已读记录
- 确保信息更新不遗漏
- 只影响弹窗公告
- 批量操作，性能高
- 有日志输出，可追踪

✅ **用户价值**:
- 重要信息不会错过
- 及时了解最新内容
- 避免基于旧信息行事

✅ **管理价值**:
- 自动化处理，无需手动
- 确保通知到位
- 便于追踪和管理
