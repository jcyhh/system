# 前端调用示例

## 一、页面结构建议

```
/pages/
├── index/                  # 首页（展示排队情况）
│   └── index.vue
├── register/               # 到达登记页
│   └── register.vue
├── complete/               # 完成卸货页
│   └── complete.vue
├── list/                   # 排队列表页
│   └── list.vue
└── my/                     # 我的页面
    └── my.vue
```

---

## 二、核心功能实现

### 1. 扫码登记（register.vue）

```vue
<template>
  <view class="register-page">
    <view class="form">
      <input v-model="form.driver_name" placeholder="请输入司机姓名" />
      <input v-model="form.phone" type="number" placeholder="请输入联系电话" />
      <input v-model="form.plate_number" placeholder="请输入车牌号" />
      <input v-model="form.truck_length" placeholder="请输入车长（如：9.6米）" />
      <input v-model="form.loading_place" placeholder="请输入装货地点" />
      
      <button @click="chooseImage">选择到达照片（从相册）</button>
      <image v-if="form.arrival_photo" :src="form.arrival_photo" mode="aspectFit"></image>
      
      <button @click="submit">提交登记</button>
    </view>
  </view>
</template>

<script>
export default {
  data() {
    return {
      form: {
        driver_name: '',
        phone: '',
        plate_number: '',
        truck_length: '',
        loading_place: '',
        arrival_photo: ''
      },
      tempFilePath: '' // 临时文件路径
    }
  },
  
  onLoad() {
    // 从缓存读取司机信息（方便重复使用）
    const cacheDriver = uni.getStorageSync('driver_info')
    if (cacheDriver) {
      this.form.driver_name = cacheDriver.driver_name || ''
      this.form.phone = cacheDriver.phone || ''
      this.form.plate_number = cacheDriver.plate_number || ''
    }
  },
  
  methods: {
    // 选择照片（从相册，用户已用外部水印相机拍摄）
    async chooseImage() {
      try {
        const res = await uni.chooseImage({
          count: 1,
          sourceType: ['album', 'camera'], // 优先相册，也支持现场拍照
          sizeType: ['compressed']
        })
        
        this.tempFilePath = res.tempFilePaths[0]
        this.form.arrival_photo = res.tempFilePaths[0]
        
        uni.showToast({ title: '照片已选择', icon: 'success' })
      } catch (e) {
        console.error('选择照片失败', e)
      }
    },
    
    // 上传图片到云存储
    async uploadImage() {
      if (!this.tempFilePath) return ''
      
      uni.showLoading({ title: '上传照片中...' })
      
      try {
        const uploadRes = await uniCloud.uploadFile({
          filePath: this.tempFilePath,
          cloudPath: `trucks/arrival/${Date.now()}_${Math.random().toString(36).substr(2, 9)}.jpg`,
          cloudPathAsRealPath: false
        })
        
        uni.hideLoading()
        return uploadRes.fileID
      } catch (e) {
        uni.hideLoading()
        console.error('上传失败', e)
        return ''
      }
    },
    
    // 提交登记
    async submit() {
      // 表单验证
      if (!this.form.driver_name) {
        return uni.showToast({ title: '请输入司机姓名', icon: 'none' })
      }
      if (!this.form.phone) {
        return uni.showToast({ title: '请输入联系电话', icon: 'none' })
      }
      if (!/^1[3-9]\d{9}$/.test(this.form.phone)) {
        return uni.showToast({ title: '请输入正确的手机号', icon: 'none' })
      }
      if (!this.form.plate_number) {
        return uni.showToast({ title: '请输入车牌号', icon: 'none' })
      }
      if (!this.form.truck_length) {
        return uni.showToast({ title: '请输入车长', icon: 'none' })
      }
      if (!this.form.loading_place) {
        return uni.showToast({ title: '请输入装货地点', icon: 'none' })
      }
      
      uni.showLoading({ title: '登记中...' })
      
      try {
        // 上传照片
        const photoUrl = await this.uploadImage()
        
        // 导入云对象
        const truck = uniCloud.importObject('truck')
        
        // 调用登记接口
        const res = await truck.register({
          driver_name: this.form.driver_name,
          phone: this.form.phone,
          plate_number: this.form.plate_number,
          truck_length: this.form.truck_length,
          loading_place: this.form.loading_place,
          arrival_photo: photoUrl
        })
        
        uni.hideLoading()
        
        if (res.errCode === 0) {
          // 缓存司机信息
          uni.setStorageSync('driver_info', {
            driver_name: this.form.driver_name,
            phone: this.form.phone,
            plate_number: this.form.plate_number
          })
          
          // 缓存记录ID
          uni.setStorageSync('current_record_id', res.data.id)
          
          uni.showModal({
            title: '登记成功',
            content: `您的排队号是：${res.data.queue_number}\n当前状态：${res.data.status === 'processing' ? '处理中' : '排队中'}`,
            showCancel: false,
            success: () => {
              uni.navigateBack()
            }
          })
        } else {
          uni.showToast({ title: res.errMsg, icon: 'none' })
        }
      } catch (e) {
        uni.hideLoading()
        console.error('登记失败', e)
        uni.showToast({ title: '登记失败，请重试', icon: 'none' })
      }
    }
  }
}
</script>
```

---

### 2. 完成卸货（complete.vue）

```vue
<template>
  <view class="complete-page">
    <view v-if="recordInfo">
      <view class="info">
        <text>司机：{{ recordInfo.driver_name }}</text>
        <text>车牌：{{ recordInfo.plate_number }}</text>
        <text>排队号：{{ recordInfo.queue_number }}</text>
      </view>
      
      <button @click="chooseImage">选择卸货完成照片（从相册）</button>
      <image v-if="unload_photo" :src="unload_photo" mode="aspectFit"></image>
      
      <button @click="submit">确认完成</button>
    </view>
    
    <view v-else>
      <button @click="searchTask">查询我的任务</button>
    </view>
  </view>
</template>

<script>
export default {
  data() {
    return {
      recordInfo: null,
      unload_photo: '',
      tempFilePath: ''
    }
  },
  
  onLoad() {
    this.loadCurrentTask()
  },
  
  methods: {
    // 加载当前任务
    async loadCurrentTask() {
      const recordId = uni.getStorageSync('current_record_id')
      if (!recordId) {
        return
      }
      
      uni.showLoading({ title: '加载中...' })
      
      try {
        const truck = uniCloud.importObject('truck')
        const res = await truck.getDetail(recordId)
        
        uni.hideLoading()
        
        if (res.errCode === 0) {
          this.recordInfo = res.data
          
          if (res.data.status === 'completed') {
            uni.showModal({
              title: '提示',
              content: '该任务已完成',
              showCancel: false
            })
          } else if (res.data.status === 'waiting') {
            uni.showModal({
              title: '提示',
              content: '请等待前面的车辆卸货完成',
              showCancel: false
            })
          }
        } else {
          uni.showToast({ title: res.errMsg, icon: 'none' })
        }
      } catch (e) {
        uni.hideLoading()
        console.error('加载失败', e)
      }
    },
    
    // 查询任务
    async searchTask() {
      const driverInfo = uni.getStorageSync('driver_info')
      if (!driverInfo || !driverInfo.phone || !driverInfo.plate_number) {
        return uni.showToast({ title: '请先进行到达登记', icon: 'none' })
      }
      
      uni.showLoading({ title: '查询中...' })
      
      try {
        const truck = uniCloud.importObject('truck')
        const res = await truck.getCurrentTask(driverInfo.phone, driverInfo.plate_number)
        
        uni.hideLoading()
        
        if (res.errCode === 0 && res.data) {
          this.recordInfo = res.data
          uni.setStorageSync('current_record_id', res.data._id)
        } else {
          uni.showToast({ title: '未找到进行中的任务', icon: 'none' })
        }
      } catch (e) {
        uni.hideLoading()
        console.error('查询失败', e)
      }
    },
    
    // 选择照片（从相册，用户已用外部水印相机拍摄）
    async chooseImage() {
      try {
        const res = await uni.chooseImage({
          count: 1,
          sourceType: ['album', 'camera'], // 优先相册，也支持现场拍照
          sizeType: ['compressed']
        })
        
        this.tempFilePath = res.tempFilePaths[0]
        this.unload_photo = res.tempFilePaths[0]
        
        uni.showToast({ title: '照片已选择', icon: 'success' })
      } catch (e) {
        console.error('选择照片失败', e)
      }
    },
    
    // 上传图片
    async uploadImage() {
      if (!this.tempFilePath) return ''
      
      uni.showLoading({ title: '上传照片中...' })
      
      try {
        const uploadRes = await uniCloud.uploadFile({
          filePath: this.tempFilePath,
          cloudPath: `trucks/unload/${Date.now()}_${Math.random().toString(36).substr(2, 9)}.jpg`,
          cloudPathAsRealPath: false
        })
        
        uni.hideLoading()
        return uploadRes.fileID
      } catch (e) {
        uni.hideLoading()
        console.error('上传失败', e)
        return ''
      }
    },
    
    // 提交完成
    async submit() {
      if (!this.recordInfo) {
        return uni.showToast({ title: '请先查询任务', icon: 'none' })
      }
      
      if (this.recordInfo.status !== 'processing') {
        return uni.showToast({ title: '当前状态不允许完成操作', icon: 'none' })
      }
      
      uni.showLoading({ title: '提交中...' })
      
      try {
        // 上传照片
        const photoUrl = await this.uploadImage()
        
        // 调用完成接口
        const truck = uniCloud.importObject('truck')
        const res = await truck.complete(this.recordInfo._id, photoUrl)
        
        uni.hideLoading()
        
        if (res.errCode === 0) {
          // 清除缓存
          uni.removeStorageSync('current_record_id')
          
          uni.showModal({
            title: '完成',
            content: '卸货已完成！',
            showCancel: false,
            success: () => {
              uni.navigateBack()
            }
          })
        } else {
          uni.showToast({ title: res.errMsg, icon: 'none' })
        }
      } catch (e) {
        uni.hideLoading()
        console.error('提交失败', e)
        uni.showToast({ title: '提交失败，请重试', icon: 'none' })
      }
    }
  }
}
</script>
```

---

### 3. 排队列表（list.vue）

```vue
<template>
  <view class="list-page">
    <view class="tabs">
      <text 
        :class="['tab', currentTab === 'processing' ? 'active' : '']" 
        @click="changeTab('processing')"
      >处理中</text>
      <text 
        :class="['tab', currentTab === 'waiting' ? 'active' : '']" 
        @click="changeTab('waiting')"
      >排队中</text>
      <text 
        :class="['tab', currentTab === 'completed' ? 'active' : '']" 
        @click="changeTab('completed')"
      >已完成</text>
    </view>
    
    <scroll-view 
      scroll-y 
      class="list-scroll" 
      @scrolltolower="loadMore"
      refresher-enabled 
      @refresherrefresh="refresh"
      :refresher-triggered="refreshing"
    >
      <view class="list-item" v-for="item in list" :key="item._id" @click="viewDetail(item)">
        <view class="item-header">
          <text class="queue-number">{{ item.queue_number }}号</text>
          <text :class="['status', item.status]">
            {{ item.status === 'processing' ? '处理中' : item.status === 'waiting' ? '排队中' : '已完成' }}
          </text>
        </view>
        <view class="item-info">
          <text>司机：{{ item.driver_name }}</text>
          <text>车牌：{{ item.plate_number }}</text>
          <text>车长：{{ item.truck_length }}</text>
        </view>
        <view class="item-time">
          <text>到达：{{ formatTime(item.arrival_time) }}</text>
          <text v-if="item.unload_time">完成：{{ formatTime(item.unload_time) }}</text>
        </view>
      </view>
      
      <view v-if="list.length === 0" class="empty">暂无数据</view>
      <view v-if="noMore" class="no-more">没有更多了</view>
    </scroll-view>
  </view>
</template>

<script>
export default {
  data() {
    return {
      currentTab: 'processing',
      list: [],
      page: 1,
      pageSize: 20,
      noMore: false,
      refreshing: false
    }
  },
  
  onLoad() {
    this.loadList()
    
    // 定时刷新（可选）
    this.timer = setInterval(() => {
      this.refresh()
    }, 30000) // 30秒刷新一次
  },
  
  onUnload() {
    if (this.timer) {
      clearInterval(this.timer)
    }
  },
  
  methods: {
    // 切换标签
    changeTab(tab) {
      this.currentTab = tab
      this.page = 1
      this.list = []
      this.noMore = false
      this.loadList()
    },
    
    // 加载列表
    async loadList() {
      uni.showLoading({ title: '加载中...' })
      
      try {
        const truck = uniCloud.importObject('truck')
        const res = await truck.getList(this.currentTab, this.page, this.pageSize)
        
        uni.hideLoading()
        
        if (res.errCode === 0) {
          if (this.page === 1) {
            this.list = res.data.list
          } else {
            this.list = [...this.list, ...res.data.list]
          }
          
          // 判断是否还有更多
          if (this.list.length >= res.data.total) {
            this.noMore = true
          }
        } else {
          uni.showToast({ title: res.errMsg, icon: 'none' })
        }
      } catch (e) {
        uni.hideLoading()
        console.error('加载失败', e)
      }
    },
    
    // 下拉刷新
    async refresh() {
      this.refreshing = true
      this.page = 1
      this.noMore = false
      await this.loadList()
      this.refreshing = false
    },
    
    // 加载更多
    loadMore() {
      if (this.noMore) return
      this.page++
      this.loadList()
    },
    
    // 查看详情
    viewDetail(item) {
      uni.navigateTo({
        url: `/pages/detail/detail?id=${item._id}`
      })
    },
    
    // 格式化时间
    formatTime(timestamp) {
      const date = new Date(timestamp)
      const Y = date.getFullYear()
      const M = (date.getMonth() + 1).toString().padStart(2, '0')
      const D = date.getDate().toString().padStart(2, '0')
      const h = date.getHours().toString().padStart(2, '0')
      const m = date.getMinutes().toString().padStart(2, '0')
      return `${Y}-${M}-${D} ${h}:${m}`
    }
  }
}
</script>

<style scoped>
.tabs {
  display: flex;
  background: #fff;
  padding: 20rpx;
}
.tab {
  flex: 1;
  text-align: center;
  padding: 20rpx;
}
.tab.active {
  color: #007aff;
  border-bottom: 2px solid #007aff;
}
.list-item {
  background: #fff;
  margin: 20rpx;
  padding: 30rpx;
  border-radius: 10rpx;
  box-shadow: 0 2rpx 10rpx rgba(0,0,0,0.1);
}
.status.processing {
  color: #ff9500;
}
.status.waiting {
  color: #999;
}
.status.completed {
  color: #4cd964;
}
</style>
```

---

### 4. 首页统计（index.vue）

```vue
<template>
  <view class="index-page">
    <view class="stats">
      <view class="stat-item">
        <text class="stat-number">{{ stats.processing }}</text>
        <text class="stat-label">处理中</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{ stats.waiting }}</text>
        <text class="stat-label">排队中</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{ stats.completed_today }}</text>
        <text class="stat-label">今日完成</text>
      </view>
    </view>
    
    <view class="actions">
      <button type="primary" @click="goRegister">到达登记</button>
      <button type="default" @click="goComplete">完成卸货</button>
      <button type="default" @click="goList">查看排队</button>
    </view>
  </view>
</template>

<script>
export default {
  data() {
    return {
      stats: {
        processing: 0,
        waiting: 0,
        completed_today: 0
      }
    }
  },
  
  onShow() {
    this.loadStats()
  },
  
  methods: {
    // 加载统计
    async loadStats() {
      try {
        const truck = uniCloud.importObject('truck')
        const res = await truck.getQueueStats()
        
        if (res.errCode === 0) {
          this.stats = res.data
        }
      } catch (e) {
        console.error('加载统计失败', e)
      }
    },
    
    goRegister() {
      uni.navigateTo({ url: '/pages/register/register' })
    },
    
    goComplete() {
      uni.navigateTo({ url: '/pages/complete/complete' })
    },
    
    goList() {
      uni.navigateTo({ url: '/pages/list/list' })
    }
  }
}
</script>
```

---

## 三、扫码功能实现

### 在首页添加扫码按钮

```vue
<button @click="scanCode">扫码登记</button>
```

```javascript
methods: {
  async scanCode() {
    try {
      const res = await uni.scanCode({
        scanType: ['qrCode']
      })
      
      // 解析二维码内容
      const result = res.result
      
      // 如果二维码包含特定标识，跳转到对应页面
      if (result.includes('register')) {
        uni.navigateTo({ url: '/pages/register/register' })
      } else if (result.includes('complete')) {
        uni.navigateTo({ url: '/pages/complete/complete' })
      }
    } catch (e) {
      console.error('扫码失败', e)
    }
  }
}
```

---

## 四、全局配置（main.js）

```javascript
import App from './App'
import { createSSRApp } from 'vue'

export function createApp() {
  const app = createSSRApp(App)
  
  // 全局错误处理
  app.config.errorHandler = (err) => {
    console.error('全局错误：', err)
  }
  
  return {
    app
  }
}
```

---

## 五、注意事项

1. **云对象导入**：每次调用都要 `uniCloud.importObject('truck')`
2. **异步处理**：所有云对象方法都是异步的，需要使用 `async/await`
3. **错误处理**：必须用 `try-catch` 包裹云对象调用
4. **图片上传**：先上传到云存储，再将 fileID 传给云对象
5. **缓存策略**：合理使用 `uni.getStorageSync` 缓存司机信息
6. **权限配置**：微信小程序需要配置 `camera`、`chooseImage` 权限

---

## 六、manifest.json 配置

```json
{
  "mp-weixin": {
    "appid": "your-appid",
    "permission": {
      "scope.album": {
        "desc": "用于选择相册中的水印照片"
      },
      "scope.camera": {
        "desc": "支持现场拍照"
      }
    },
    "uniStatistics": {
      "enable": false
    }
  }
}
```

---

## 七、pages.json 配置

```json
{
  "pages": [
    {
      "path": "pages/index/index",
      "style": {
        "navigationBarTitleText": "仓库卸货管理"
      }
    },
    {
      "path": "pages/register/register",
      "style": {
        "navigationBarTitleText": "到达登记"
      }
    },
    {
      "path": "pages/complete/complete",
      "style": {
        "navigationBarTitleText": "完成卸货"
      }
    },
    {
      "path": "pages/list/list",
      "style": {
        "navigationBarTitleText": "排队列表"
      }
    }
  ],
  "globalStyle": {
    "navigationBarTextStyle": "black",
    "navigationBarTitleText": "仓库管理",
    "navigationBarBackgroundColor": "#F8F8F8",
    "backgroundColor": "#F8F8F8"
  }
}
```

