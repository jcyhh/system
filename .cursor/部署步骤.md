# 仓库卸货管理系统 - 部署步骤

## 一、准备工作

### 1. 开发工具
- 下载安装 **HBuilderX** 最新版本
- 下载安装 **微信开发者工具**

### 2. 账号准备
- **DCloud账号**：用于登录HBuilderX和uniCloud
- **微信小程序账号**：在 https://mp.weixin.qq.com 注册

### 3. 获取微信小程序信息
1. 登录微信小程序后台
2. 进入 **开发** → **开发管理** → **开发设置**
3. 记录以下信息：
   - AppID（小程序ID）
   - AppSecret（小程序密钥）

---

## 二、创建uniCloud服务空间

### 步骤1：在HBuilderX中关联服务空间

1. 打开项目
2. 在项目目录中找到 `uniCloud-aliyun` 文件夹
3. 右键点击 `uniCloud-aliyun` → **关联云服务空间或项目**
4. 如果没有服务空间，点击 **创建新的服务空间**
   - 选择 **阿里云**
   - 输入服务空间名称（如：warehouse-system）
   - 点击创建

### 步骤2：等待服务空间初始化

创建后需要等待几分钟，服务空间状态变为"运行中"即可使用。

---

## 三、配置uni-id（重要）

### 步骤1：修改uni-id配置文件

找到文件：`/uniCloud-aliyun/cloudfunctions/common/uni-config-center/uni-id/config.json`

修改以下内容：

```json
{
  "passwordSecret": "warehouse-2024-your-custom-secret",  // ← 修改为自定义密钥
  "tokenSecret": "warehouse-2024-your-token-secret",      // ← 修改为自定义密钥
  "tokenExpiresIn": 7200000,
  "tokenExpiresThreshold": 600000,
  "passwordErrorLimit": 6,
  "passwordErrorRetryTime": 3600000,
  "autoSetInviteCode": false,
  "forceInviteCode": false,
  "removePermissionAndRoleFromToken": true,
  "mp-weixin": {
    "oauth": {
      "weixin": {
        "appid": "wx1234567890abcdef",      // ← 修改为你的小程序AppID
        "appsecret": "your-appsecret-here"  // ← 修改为你的小程序AppSecret
      }
    }
  }
}
```

**重要提示：**
- `passwordSecret` 和 `tokenSecret` 必须修改为随机字符串（建议30位以上）
- `appid` 和 `appsecret` 必须填写真实的微信小程序信息

### 步骤2：上传公共模块

1. 右键点击 `/uniCloud-aliyun/cloudfunctions/common` 文件夹
2. 选择 **上传公共模块**
3. 等待上传完成

---

## 四、部署云函数（云对象）

### 步骤1：上传 truck 云对象

1. 右键点击 `/uniCloud-aliyun/cloudfunctions/truck` 文件夹
2. 选择 **上传部署**
3. 等待上传完成（第一次上传需要安装依赖，可能需要1-2分钟）

### 步骤2：上传 user 云对象

1. 右键点击 `/uniCloud-aliyun/cloudfunctions/user` 文件夹
2. 选择 **上传部署**
3. 等待上传完成

### 验证云函数是否部署成功

1. 打开 uniCloud web控制台：https://unicloud.dcloud.net.cn
2. 进入对应的服务空间
3. 点击 **云函数** 菜单
4. 查看是否有 `truck` 和 `user` 两个云对象

---

## 五、初始化数据库

### 步骤1：上传数据库表结构

1. 右键点击 `/uniCloud-aliyun/database/trucks.schema.json` 文件
2. 选择 **上传DB Schema**
3. 等待上传完成

### 步骤2：初始化示例数据（可选）

1. 打开 uniCloud web控制台
2. 进入 **云数据库** → **数据库**
3. 点击 **导入**
4. 选择 `/uniCloud-aliyun/database/db_init.json` 文件
5. 点击导入

### 验证数据库是否创建成功

1. 在 uniCloud web控制台
2. 进入 **云数据库** → **数据库**
3. 查看是否有 `trucks` 表

---

## 六、配置小程序

### 步骤1：修改 manifest.json

找到文件：`/manifest.json`

修改以下内容：

```json
{
  "mp-weixin": {
    "appid": "wx1234567890abcdef",  // ← 修改为你的小程序AppID
    "setting": {
      "urlCheck": false
    },
    "usingComponents": true,
    "permission": {
      "scope.album": {
        "desc": "用于选择相册中的水印照片"
      },
      "scope.camera": {
        "desc": "支持现场拍照（可选）"
      }
    }
  }
}
```

### 步骤2：关联uniCloud服务空间到前端

1. 打开 `App.vue` 或 `main.js`
2. 确保项目已关联云服务空间（右下角会显示服务空间名称）

---

## 七、本地调试

### 步骤1：在HBuilderX中运行

1. 点击顶部菜单 **运行** → **运行到小程序模拟器** → **微信开发者工具**
2. 第一次运行会自动打开微信开发者工具
3. 如果提示"服务端口已关闭"，在微信开发者工具中：
   - 点击 **设置** → **安全设置**
   - 开启 **服务端口**

### 步骤2：测试云函数

在前端页面中测试调用：

```javascript
const truck = uniCloud.importObject('truck')

// 测试获取统计信息
async function test() {
  const res = await truck.getQueueStats()
  console.log('统计信息：', res)
}

test()
```

查看控制台输出，如果返回数据则说明后端正常工作。

---

## 八、发布到微信小程序

### 步骤1：在HBuilderX中构建

1. 点击顶部菜单 **发行** → **小程序-微信**
2. 填写小程序名称和AppID
3. 点击 **发行**
4. 等待编译完成

### 步骤2：在微信开发者工具中上传

1. 编译完成后会自动打开微信开发者工具
2. 点击右上角 **上传**
3. 填写版本号和项目备注
4. 点击 **上传**

### 步骤3：提交审核

1. 登录微信小程序后台
2. 进入 **版本管理**
3. 找到刚才上传的版本
4. 点击 **提交审核**
5. 按照提示填写审核信息

### 步骤4：发布上线

审核通过后，在小程序后台点击 **发布** 即可正式上线。

---

## 九、配置服务器域名（重要）

### 步骤1：获取uniCloud域名

1. 打开 uniCloud web控制台
2. 进入对应的服务空间
3. 点击 **前端网页托管** 或 **云函数URL化**
4. 复制显示的域名（通常是 `xxx.bspapp.com` 或 `xxx.tcb-api.tencentcloudapi.com`）

### 步骤2：在微信小程序后台配置

1. 登录微信小程序后台
2. 进入 **开发** → **开发管理** → **开发设置**
3. 找到 **服务器域名**
4. 添加以下域名：
   - **request合法域名**：添加 uniCloud 的 API 域名
   - **uploadFile合法域名**：添加 uniCloud 的存储域名
   - **downloadFile合法域名**：添加 uniCloud 的存储域名

**阿里云 uniCloud 常用域名：**
```
https://api.bspapp.com
https://vkceyugu.cdn.bspapp.com
https://tcb-api.tencentcloudapi.com
```

**注意：** 具体域名请以 uniCloud 控制台显示的为准！

---

## 十、常见问题排查

### 1. 云函数调用失败

**现象：** 前端调用云对象时报错

**排查步骤：**
1. 检查是否已上传云函数
2. 检查是否已关联服务空间
3. 在 uniCloud 控制台查看云函数日志
4. 检查网络是否正常

### 2. 登录失败

**现象：** 微信登录时返回错误

**排查步骤：**
1. 检查 `uni-id/config.json` 中的 appid 和 appsecret 是否正确
2. 检查是否已上传公共模块
3. 检查小程序是否已关联云服务空间

### 3. 图片上传失败

**现象：** 上传图片时报错

**排查步骤：**
1. 检查是否已配置云存储域名到小程序后台
2. 检查云存储空间是否已初始化
3. 检查图片大小是否超限（建议压缩后上传）

### 4. 数据库操作失败

**现象：** 增删改查时报错

**排查步骤：**
1. 检查是否已上传 DB Schema
2. 检查权限配置是否正确
3. 在 uniCloud 控制台手动测试数据库操作

---

## 十一、性能优化建议

### 1. 添加数据库索引

在 uniCloud 控制台 → 云数据库 → trucks 表 → 索引管理

添加以下索引：
- `status` (单字段索引)
- `arrival_time` (单字段索引)
- `{phone: 1, plate_number: 1, status: 1}` (组合索引)

### 2. 开启 CDN 加速

在 uniCloud 控制台 → 云存储 → CDN 加速，开启 CDN

### 3. 配置缓存

对于统计数据，可以在前端添加缓存：

```javascript
// 缓存5分钟
const CACHE_TIME = 5 * 60 * 1000

async function getQueueStats() {
  const cache = uni.getStorageSync('stats_cache')
  const now = Date.now()
  
  if (cache && (now - cache.time) < CACHE_TIME) {
    return cache.data
  }
  
  const truck = uniCloud.importObject('truck')
  const res = await truck.getQueueStats()
  
  if (res.errCode === 0) {
    uni.setStorageSync('stats_cache', {
      data: res.data,
      time: now
    })
  }
  
  return res.data
}
```

---

## 十二、安全建议

1. **修改密钥**：生产环境必须修改 `passwordSecret` 和 `tokenSecret`
2. **限制权限**：根据实际需求调整数据库权限
3. **定期备份**：在 uniCloud 控制台定期导出数据库备份
4. **监控日志**：定期查看云函数日志，发现异常及时处理
5. **版本管理**：使用 git 管理代码版本

---

## 十三、后续维护

### 日常维护
- 定期查看云函数调用量和错误日志
- 定期清理历史数据（已完成超过30天的记录）
- 监控服务空间资源使用情况

### 功能扩展
- 添加管理员后台
- 添加消息推送功能
- 添加数据统计报表
- 添加二维码生成功能

---

## 需要帮助？

- uniCloud 官方文档：https://doc.dcloud.net.cn/uniCloud/
- uni-app 官方文档：https://uniapp.dcloud.net.cn/
- DCloud 社区：https://ask.dcloud.net.cn/
- uniCloud 官方技术交流群：见文档说明

---

**部署完成！祝您使用愉快！** 🎉

