# 公告管理功能说明

## 功能概述

管理员可以在公告列表页面直接进行公告的添加、编辑和删除操作。普通用户只能查看已发布的公告。

---

## 前端实现

### 1. 页面结构

**公告列表页**: `pages/notice/list.vue`
- 显示公告列表
- 管理员权限判断
- 添加、编辑、删除操作入口

**公告编辑页**: `pages/notice/edit.vue`
- 新增和编辑公告的表单页面
- 支持通过 URL 参数 `id` 区分新增和编辑模式
- 独立页面，操作更流畅

### 2. 权限判断

**页面路径**: `pages/notice/list.vue`

```typescript
// 判断是否是管理员
const isAdmin = computed(() => {
  return appStore.isLogin && appStore.role === 1
})
```

**显示规则**:
- ✅ **管理员登录**：显示"添加公告"按钮、编辑、删除图标、公告状态标签
- ❌ **普通用户**：只显示公告列表，不显示管理功能

---

### 3. 管理功能

#### 添加公告

**触发方式**: 点击底部"添加公告"按钮

**功能**:
- 跳转到编辑页面（`/pages/notice/edit`）
- 填写标题、内容
- 选择是否发布、是否弹窗
- 提交后返回列表页并刷新

#### 编辑公告

**触发方式**: 点击公告右侧的编辑图标（笔形图标）

**功能**:
- 跳转到编辑页面（`/pages/notice/edit?id=xxx`）
- 自动加载并填充原有数据
- 修改标题、内容、发布状态、弹窗状态
- 提交后返回列表页并刷新

#### 删除公告

**触发方式**: 点击公告右侧的删除图标（垃圾桶图标）

**功能**:
- 弹出确认对话框
- 确认后删除公告
- 删除成功后刷新列表

---

### 4. 状态标签

管理员在列表中可以看到公告的状态：

| 标签 | 颜色 | 含义 |
|------|------|------|
| **未发布** | 橙色 | 公告未发布，用户看不到 |
| **弹窗** | 蓝色 | 该公告会在用户登录后弹窗展示 |

---

## 云函数接口

### 1. 获取公告列表

**方法**: `getList`

**请求参数**:
```javascript
{
  page: 1,           // 页码
  pageSize: 20,      // 每页数量
  limit: 5,          // 限制数量（可选，用于首页）
  showAll: true      // 是否显示所有（管理员用）
}
```

**返回数据**:
```javascript
{
  errCode: 0,
  errMsg: '获取成功',
  data: {
    list: [...],
    total: 10,
    page: 1,
    pageSize: 20
  }
}
```

**说明**:
- `showAll: true` 时，管理员可以看到所有公告（包括未发布的）
- 普通用户或未登录用户只能看到已发布的公告

---

### 2. 创建公告

**方法**: `create`

**请求参数**:
```javascript
{
  title: '公告标题',         // 必填
  content: '公告内容',       // 必填
  is_published: true,       // 可选，默认 true
  is_popup: false           // 可选，默认 false
}
```

**返回数据**:
```javascript
{
  errCode: 0,
  errMsg: '创建成功',
  data: {
    id: '新建公告的ID'
  }
}
```

**权限**: 需要管理员权限

---

### 3. 更新公告

**方法**: `update`

**请求参数**:
```javascript
{
  id: '公告ID',              // 必填
  title: '新标题',           // 可选
  content: '新内容',         // 可选
  is_published: false,      // 可选
  is_popup: true            // 可选
}
```

**返回数据**:
```javascript
{
  errCode: 0,
  errMsg: '更新成功'
}
```

**权限**: 需要管理员权限

**说明**: 至少需要修改一个字段

---

### 4. 删除公告

**方法**: `delete`

**请求参数**:
```javascript
{
  id: '公告ID'  // 必填
}
```

**返回数据**:
```javascript
{
  errCode: 0,
  errMsg: '删除成功'
}
```

**权限**: 需要管理员权限

---

## 使用流程

### 管理员操作流程

#### 1. 添加新公告

1. 进入公告列表页
2. 点击底部"添加公告"按钮
3. 跳转到编辑页面
4. 填写公告标题和内容
5. 选择是否发布（默认发布）
6. 选择是否弹窗展示（默认不弹窗）
7. 点击"创建公告"提交
8. 自动返回列表页

#### 2. 编辑公告

1. 在公告列表中找到要编辑的公告
2. 点击右侧的编辑图标（笔形）
3. 跳转到编辑页面，自动加载公告数据
4. 修改标题、内容或状态
5. 点击"保存修改"保存
6. 自动返回列表页

#### 3. 删除公告

1. 在公告列表中找到要删除的公告
2. 点击右侧的删除图标（垃圾桶）
3. 确认删除操作

#### 4. 管理公告状态

**发布/取消发布**:
- 编辑公告时，切换"是否发布"开关
- 关闭发布后，用户将看不到该公告

**设置弹窗**:
- 编辑公告时，打开"是否弹窗展示"开关
- 启用后，用户登录时会自动弹出该公告
- 用户点击"我已知晓"后不再弹出

---

## 界面说明

### 公告列表（管理员视图）

```
┌─────────────────────────────────────┐
│  公告标题（最多显示2行）   [未发布] [弹窗] │
│  2026-01-15 14:30    ✏️  🗑️         │
└─────────────────────────────────────┘
```

**图标说明**:
- ✏️ 编辑图标：点击编辑公告
- 🗑️ 删除图标：点击删除公告
- `[未发布]` 橙色标签：该公告未发布
- `[弹窗]` 蓝色标签：该公告会弹窗展示

---

### 编辑页面

```
┌──────────────────────────────────┐
│  < 添加公告 / 编辑公告             │
├──────────────────────────────────┤
│  公告标题                          │
│  [                              ]  │
│                                    │
│  公告内容                          │
│  [                              ]  │
│  [                              ]  │
│  [                              ]  │
│  [                              ]  │
│                                    │
│  是否发布           [开关]         │
│  是否弹窗展示       [开关]         │
│                                    │
│  [   创建公告 / 保存修改   ]       │
└──────────────────────────────────┘
```

---

## 注意事项

### 1. 权限控制

- ✅ 所有管理功能都需要管理员权限
- ❌ 非管理员用户无法访问编辑、删除接口
- ✅ 前端和后端都有权限验证

### 2. 数据验证

- 标题和内容必填
- 标题最多显示2行，超出部分省略
- 内容支持HTML格式

### 3. 弹窗规则

- 每个用户只会看到一次弹窗公告
- 点击"我已知晓"后永不再弹
- 可以同时设置多条弹窗公告，系统会按时间倒序逐条展示

### 4. 删除注意

- 删除操作不可撤销
- 删除后用户将无法查看该公告
- 建议使用"取消发布"代替删除

---

## 部署步骤

### 1. 上传云函数

```bash
右键 notice 文件夹 → 上传并部署
```

### 2. 测试功能

1. 使用管理员账号登录小程序
2. 进入公告列表页
3. 测试添加、编辑、删除功能
4. 验证状态标签显示正确
5. 测试弹窗功能

---

## 错误处理

### 常见错误

| 错误信息 | 原因 | 解决方法 |
|---------|------|---------|
| 请先登录 | 未登录 | 先登录再操作 |
| 无权限操作 | 不是管理员 | 使用管理员账号登录 |
| 标题和内容不能为空 | 必填项为空 | 填写完整信息 |
| 至少需要修改一个字段 | 更新时没有修改任何内容 | 至少修改一个字段 |

---

## 总结

✅ **实现功能**:
- 管理员权限判断
- 添加公告
- 编辑公告
- 删除公告
- 状态标签展示
- 管理员查看所有公告（包括未发布的）

✅ **用户体验**:
- 独立页面编辑，操作流畅
- 自动加载数据
- 自动返回刷新
- 状态可视化
- 删除前确认

✅ **安全性**:
- 前后端双重权限验证
- 参数校验
- 错误提示
