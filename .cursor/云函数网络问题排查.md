# 云函数网络问题排查

## 问题现象
- 错误：`ResponseTimeoutError: Response timeout for 15000ms`
- 状态：`connected: true` 但 `socketHandledResponses: 0`
- 原因：云函数可以建立TCP连接，但HTTP响应被阻塞

## 解决步骤

### 1. 检查云服务空间类型
登录 [uniCloud Web控制台](https://unicloud.dcloud.net.cn/)
- 确认是否是**付费版**（按量付费或包年包月）
- 免费版有网络访问限制，需要升级到付费版

### 2. 检查云函数网络配置

#### 2.1 阿里云控制台检查
1. 登录 [阿里云控制台](https://fcnext.console.aliyun.com/)
2. 找到 `函数计算FC` 服务
3. 找到你的云函数（服务名通常是 `uniCloud-xxx`）
4. 点击云函数 → `配置` → 查看 `网络配置`

#### 2.2 需要的配置
- **VPC配置**：
  - 如果配置了VPC，需要确保VPC有 **NAT网关** 或 **公网访问能力**
  - 如果没有配置VPC，应该可以直接访问公网

- **安全组规则**：
  - 需要允许出站规则：HTTPS (443端口)
  - 目标地址：`api.weixin.qq.com` 或 全部

### 3. 联系阿里云客服

如果上述检查都没问题，需要联系阿里云客服：

**工单模板**：
```
标题：云函数无法访问外网API

问题描述：
您好，我在使用 uniCloud（阿里云版）的云函数时，
无法访问微信API（https://api.weixin.qq.com），请求一直超时。

错误信息：
ResponseTimeoutError: Response timeout for 15000ms
connected: true, socketHandledResponses: 0

我的配置：
- 服务空间ID：mp-692d873a-b965-422c-8fc6-6f94f4b4d9bf
- 云函数名称：truck
- 套餐类型：付费版
- 需要访问的外网地址：https://api.weixin.qq.com

请问需要如何配置才能让云函数正常访问外网API？
谢谢！
```

### 4. 临时解决方案

在问题解决之前，可以：
1. **注释掉订阅消息相关代码**，先不发送微信通知
2. 使用**短信通知**替代（如果有配置）
3. 仅在前端显示提示，不发送服务器通知

## 可能的解决方法（需要客服确认）

### 方法1：添加NAT网关
如果云函数配置了VPC，需要为VPC配置NAT网关才能访问公网。

### 方法2：移除VPC配置
如果不需要VPC隔离，可以尝试移除云函数的VPC配置，使用默认网络。

### 方法3：使用云函数URL化代理
创建一个独立的云函数用于代理HTTP请求（比较复杂，不推荐）。

## 验证网络是否正常

使用我们创建的 `test-network` 云函数测试：
```
右键 test-network/index.obj.js → 运行到云端云函数
方法名：testWechatApi
```

如果返回 `success: true`，说明网络已经通了。

## 参考文档
- [阿里云函数计算-网络配置](https://help.aliyun.com/document_detail/72959.html)
- [uniCloud官方文档-网络问题](https://uniapp.dcloud.net.cn/uniCloud/faq.html#network)
